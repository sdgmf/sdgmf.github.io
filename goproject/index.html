<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.56.0" />

  
  <meta name="description" content="Sdgmf &#39;s Blog">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://sdgmf.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://sdgmf.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://sdgmf.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://sdgmf.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://sdgmf.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://sdgmf.github.io/css/bootstrap.min.css" />

  
  <title>Golang微服务最佳实践 | Sdgmf &#39;s Blog</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #797D7F;
}



.custom-navbar a {
  color: #17202A;
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 1600px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Golang微服务最佳实践</h1>
<p>
  <small class="text-secondary">
  
  
  Jul 24, 2019
  </small>
  

<small><code><a href="https://sdgmf.github.io/tags/golang">golang</a></code></small>


<small><code><a href="https://sdgmf.github.io/tags/dependency-inject">dependency-inject</a></code></small>


<small><code><a href="https://sdgmf.github.io/tags/unit-test">unit-test</a></code></small>


<small><code><a href="https://sdgmf.github.io/tags/microservice">microservice</a></code></small>


<small><code><a href="https://sdgmf.github.io/tags/grpc">grpc</a></code></small>

</p>
<p>本文通过一个完整的项目的示例，从Golang项目的结构、分层思想、依赖注入、错误处理、单元测试、服务治理、框架选择等方面介绍Go语言项目的开发经验.</p>

<h2 id="目的">目的</h2>

<ol>
<li>提供一个完整的go语言项目示例</li>
<li>介绍Go开发应该遵守的规范</li>
<li>介绍编程思想在go语言中的应用</li>
<li>服务治理相关的框架、中间件介绍</li>
<li>自动化生成监控和报警</li>
</ol>

<h2 id="示例项目">示例项目</h2>

<p>Github源码<a href="http://github.com/sdgmf/go-project-sample">go-project-sample</a></p>

<p>项目分为products、details、ratings、reviews四个微服务,依赖关系如下.</p>

<p><img src="/images/goproject_dep.jpg" alt="dependency" /></p>

<h2 id="快速开始">快速开始</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    git clone https://github.com/sdgmf/go-project-sample.git
    cd go-project-sample
    make docker-compose</code></pre></div>
<ul>
<li><strong>访问接口</strong>： <a href="http://localhost:8080/product/1">http://localhost:8080/product/1</a></li>
<li><strong>consul</strong>: <a href="http://localhost:8500/">http://localhost:8500/</a></li>
<li><strong>grafana</strong>: <a href="http://localhost:3000/">http://localhost:3000/</a></li>
<li><strong>jaeger</strong>: <a href="http://localhost:16686/search">http://localhost:16686/search</a></li>
<li><strong>Prometheus</strong>: <a href="http://localhost:9090/graph">http://localhost:9090/graph</a></li>
</ul>

<h2 id="预览">预览</h2>

<p>Grafana Dashboard,可以自动生成!</p>

<p><img src="/images/grafana_dashboard.jpg" alt="dashboard" /></p>

<p><img src="/images/grafana_dashboard1.jpg" alt="dashboard1" /></p>

<p>调用链跟踪</p>

<p><img src="/images/jaeger.jpg" alt="jaeger" /></p>

<p><img src="/images/jaeger1.jpg" alt="jaeger" /></p>

<h2 id="包结构">包结构</h2>

<p>关于golang项目的包结构，Dave Chaney博客《<a href="https://dave.cheney.net/2014/12/01/five-suggestions-for-setting-up-a-go-project">Five suggestions for setting up a Go project</a>》里讨论了package和command的包设计建议，还有一个社区普遍认可的包结构规范<a href="https://github.com/golang-standards/project-layout">project-layout</a>。在这两个两篇文章的知道下，结合常见的互联网微服务项目，我又细化了如下的项目结构。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.
├── api
│   └── proto
├── build
│   ├── details
│   ├── products
│   ├── ratings
│   └── reviews
├── cmd
│   ├── details
│   ├── products
│   ├── ratings
│   └── reviews
├── configs
├── deployments
├── dist
├── internal
│   ├── app
│   │   ├── details
│   │   │   ├── controllers
│   │   │   ├── grpcservers
│   │   │   ├── repositorys
│   │   │   └── services
│   │   ├── products
│   │   │   ├── controllers
│   │   │   ├── grpcclients
│   │   │   └── services
│   │   ├── ratings
│   │   │   ├── controllers
│   │   │   ├── grpcservers
│   │   │   ├── repositorys
│   │   │   └── services
│   │   └── reviews
│   │       ├── controllers
│   │       ├── grpcservers
│   │       ├── repositorys
│   │       └── services
│   └── pkg
│       ├── app
│       ├── config
│       ├── consul
│       ├── database
│       ├── jaeger
│       ├── log
│       ├── models
│       ├── transports
│       │   ├── grpc
│       │   └── http
│       │       └── middlewares
│       │           └── ginprom
│       └── utils
│           └── netutil
├── mocks
└── scripts</code></pre></div>
<h3 id="cmd">/cmd</h3>

<p>同<a href="https://github.com/golang-standards/project-layout">project-layout</a></p>

<blockquote>
<p>&ldquo;该项目的main方法。 每个应用程序的目录名称应与您要拥有的可执行文件的名称相匹配（例如，/cmd/myapp）。 不要在应用程序目录中放入大量代码。 如果您认为代码可以导入并在其他项目中使用，那么它应该存在于/ pkg目录中。 如果代码不可重用或者您不希望其他人重用它，请将该代码放在/ internal目录中。 你会惊讶于别人会做什么，所以要明确你的意图！ 通常有一个小的main函数可以从/ internal和/ pkg目录中导入和调用代码，而不是其他任何东西。&rdquo;</p>
</blockquote>

<h3 id="internal-pkg">/internal/pkg</h3>

<p>同<a href="https://github.com/golang-standards/project-layout">project-layout</a></p>

<blockquote>
<p>&ldquo;私有应用程序和库代码。 这是您不希望其他人在其应用程序或库中导入的代码。 将您的实际应用程序代码放在/internal/app目录（例如/internal/app/myapp）和/internal/ pkg目录中这些应用程序共享的代码（例如/internal/pkg/myprivlib）。&rdquo;</p>
</blockquote>

<p>内部的包采用平铺的方式。</p>

<h3 id="internal-pkg-config">/internal/pkg/config</h3>

<p>加载配置文件,或者从配置中心获取配置和监听配置变动。</p>

<h3 id="internal-pkg-database">/internal/pkg/database</h3>

<p>数据库连接初始化和ORM框架初始化配置。</p>

<h3 id="internal-pkg-models">/internal/pkg/models</h3>

<p>结构体定义。</p>

<h3 id="internal-pkg-transport">/internal/pkg/transport</h3>

<p>http/gpc 传输层</p>

<h3 id="internal-app-products">/internal/app/products</h3>

<p>应用内部代码</p>

<h3 id="internal-app-products-controllers">/internal/app/products/controllers</h3>

<p>MVC控制层</p>

<h3 id="internal-app-products-services">/internal/app/products/services</h3>

<p>领域逻辑层</p>

<h3 id="internal-app-products-repositorys">/internal/app/products/repositorys</h3>

<p>存储层</p>

<h3 id="internal-app-products-grpcclients">/internal/app/products/grpcclients</h3>

<p>grpc client</p>

<h3 id="internal-app-details-grpcservers">/internal/app/details/grpcservers</h3>

<p>grpc servers</p>

<h3 id="mocks">/mocks</h3>

<p>mockery 生成的mock实现</p>

<h3 id="api">/api</h3>

<p>OpenAPI/Swagger规范，JSON模式文件，协议定义文件等。</p>

<h3 id="grafana">/grafana</h3>

<p>生成grafana dashboard 用到的脚本</p>

<h3 id="scripts">/scripts</h3>

<p>sql、部署脚本等</p>

<h3 id="build">/build</h3>

<p>Dockerfile、docker-compose</p>

<h3 id="deployment">/deployment</h3>

<p>docker-compose/kubernetes等配置</p>

<h2 id="分层">分层</h2>

<p>MVC、领域模型、ORM 这些都是通过把特定职责的代码拆分到不同的层次对象里，在Java里这些分层概念在各种框架里都有体现(如SSH,SSM等常用框架组合)，并且早已形成了默认的规约，是否还适用go语言吗？答案是肯定的。Martin Fowler在《<a href="https://book.douban.com/subject/1230559/">企业应用架构模式</a>》就阐述过分层带来的各种好处。</p>

<ol>
<li>便代码复用,提高代码可维护性.如service的代码可被http协议和grpc协议复用，如果增加thrift协议的接口也很方便。</li>
<li>层次清晰，代码可读性更高。</li>
<li>方便单元测试,单元测试往往因为依赖持久的存储而无法进行,如果持久化代码抽取到单独的对象里，这就变的很简单了.</li>
</ol>

<h2 id="依赖注入">依赖注入</h2>

<p>Java 程序员都很熟悉依赖注入和控制翻转这种思想，Spring正式基于依赖注入的思想开发。依赖注入的好处是解耦，对象的组装交给容器来控制(选择需要的实现类、是否单例和初始化).基于依赖注入可以很方便的实现单元测试和提高代码可维护性。</p>

<p>关于Golang依赖注入的讨论《<a href="https://blog.drewolson.org/dependency-injection-in-go">Dependency Injection in Go</a>》,Golang依赖注入的Package有 Uber的<a href="https://github.com/uber-go/dig">dig</a>,<a href="https://github.com/uber-go/fx">fx</a>,facebook 的 <a href="https://github.com/facebookarchive/inject">inject</a>,google的<a href="https://github.com/google/wire">wire</a>。dig、fx和inject都是基于反射实现，wire是通过代码生成实现，代码生成的方式是显式的。</p>

<p>本示例通过wire来完成依赖注入. 编写wire.go,wire会根据wire.go生成代码。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// +build wireinject
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/cmd/app&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/config&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/database&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/log&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/services&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/repositorys&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/transport/http&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/transport/grpc&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">providerSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">ProviderSet</span>,
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateApp</span>(<span style="color:#a6e22e">cf</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">App</span>, <span style="color:#66d9ef">error</span>) {
    panic(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">providerSet</span>))
}</code></pre></div>
<p>生成代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/google/wire/cmd/wire

wire ./...</code></pre></div>
<p>生成后的代码在wire_gen.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Code generated by Wire. DO NOT EDIT.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//go:generate wire
</span><span style="color:#75715e">//+build !wireinject
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/cmd/app&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/config&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/database&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/log&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/services&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/repositorys&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/transport/grpc&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/app/proxy/grpcservers&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/transport/http&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/app/proxy/controllers&#34;</span>
)

<span style="color:#75715e">// Injectors from wire.go:
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateApp</span>(<span style="color:#a6e22e">cf</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">App</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">viper</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cf</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">options</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">viper</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">options</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">httpOptions</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">viper</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">databaseOptions</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">viper</span>, <span style="color:#a6e22e">logger</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">databaseOptions</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">productsRepository</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">NewMysqlProductsRepository</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">db</span>)
    <span style="color:#a6e22e">productsService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">NewProductService</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">productsRepository</span>)
    <span style="color:#a6e22e">productsController</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">NewProductsController</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">productsService</span>)
    <span style="color:#a6e22e">initControllers</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">CreateInitControllersFn</span>(<span style="color:#a6e22e">productsController</span>)
    <span style="color:#a6e22e">engine</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRouter</span>(<span style="color:#a6e22e">httpOptions</span>, <span style="color:#a6e22e">initControllers</span>)
    <span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">httpOptions</span>, <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">engine</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">grpcOptions</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">viper</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">productsServer</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpcservers</span>.<span style="color:#a6e22e">NewProductsServer</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">productsService</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">initServers</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpcservers</span>.<span style="color:#a6e22e">CreateInitServersFn</span>(<span style="color:#a6e22e">productsServer</span>)
    <span style="color:#a6e22e">grpcServer</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">grpcOptions</span>, <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">initServers</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">appApp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">grpcServer</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">appApp</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// wire.go:
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">providerSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">ProviderSet</span>)</code></pre></div>
<h2 id="面向接口编程">面向接口编程</h2>

<p>多态和单元测试必须,比较好理解不再解释。</p>

<h2 id="显式编程">显式编程</h2>

<p>Golang的开发推崇这样一种显式编程的思想，显式的初始化、方法调用和错误处理.</p>

<ol>
<li>尽可能不要使用包级别的全局变量.</li>
<li>尽量不要使用init函数，初始化操作可以在main函数中调用，这样方便阅读代码和控制初始化顺序。</li>
<li>函数都要返回错误，用if err != nil 显式的处理错误.</li>
<li>依赖的参数让调用者去控制（控制翻转的思想),可以看下节依赖注入。</li>
</ol>

<p>几个大佬都讨论过这个问题，博士Peter的《<a href="http://peter.bourgon.org/blog/2017/06/09/theory-of-modern-go.html">A theory of modern Go</a>》认为魔法代码的核心是”no package level vars; no func init“.单这也不是绝对。
Dave Cheny在《<a href="https://dave.cheney.net/2017/06/11/go-without-package-scoped-variables">go-without-package-scoped-variables</a>》做了更详细的说明.</p>

<h2 id="打印日志">打印日志</h2>

<p>使用比较多的两个日志库，<a href="https://github.com/sirupsen/logrus">logrush</a>和<a href="https://github.com/uber-go/zap">zap</a>,个人更喜欢zap。</p>

<p>初始化logger,通过viper加载日志相关配置,lumberjack负责日志切割。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Options is log configration struct
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Options</span> <span style="color:#66d9ef">struct</span> {
     <span style="color:#a6e22e">Filename</span>   <span style="color:#66d9ef">string</span>
     <span style="color:#a6e22e">MaxSize</span>    <span style="color:#66d9ef">int</span>
     <span style="color:#a6e22e">MaxBackups</span> <span style="color:#66d9ef">int</span>
     <span style="color:#a6e22e">MaxAge</span>     <span style="color:#66d9ef">int</span>
     <span style="color:#a6e22e">Level</span>      <span style="color:#66d9ef">string</span>
     <span style="color:#a6e22e">Stdout</span>     <span style="color:#66d9ef">bool</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">Viper</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Options</span>, <span style="color:#66d9ef">error</span>) {
     <span style="color:#66d9ef">var</span> (
          <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
          <span style="color:#a6e22e">o</span>   = new(<span style="color:#a6e22e">Options</span>)
     )
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">UnmarshalKey</span>(<span style="color:#e6db74">&#34;log&#34;</span>, <span style="color:#a6e22e">o</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
     }

     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">o</span>, <span style="color:#a6e22e">err</span>
}

<span style="color:#75715e">// New for init zap log library
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Options</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>, <span style="color:#66d9ef">error</span>) {
     <span style="color:#66d9ef">var</span> (
          <span style="color:#a6e22e">err</span>    <span style="color:#66d9ef">error</span>
          <span style="color:#a6e22e">level</span>  = <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">NewAtomicLevel</span>()
          <span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>
     )

     <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">level</span>.<span style="color:#a6e22e">UnmarshalText</span>([]byte(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Level</span>))
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
     }

     <span style="color:#a6e22e">fw</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">AddSync</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lumberjack</span>.<span style="color:#a6e22e">Logger</span>{
          <span style="color:#a6e22e">Filename</span>:   <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Filename</span>,
          <span style="color:#a6e22e">MaxSize</span>:    <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">MaxSize</span>, <span style="color:#75715e">// megabytes
</span><span style="color:#75715e"></span>          <span style="color:#a6e22e">MaxBackups</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">MaxBackups</span>,
          <span style="color:#a6e22e">MaxAge</span>:     <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">MaxAge</span>, <span style="color:#75715e">// days
</span><span style="color:#75715e"></span>     })

     <span style="color:#a6e22e">cw</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Lock</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>)

     <span style="color:#75715e">// file core 采用jsonEncoder
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">cores</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Core</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>)
     <span style="color:#a6e22e">je</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewJSONEncoder</span>(<span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">NewProductionEncoderConfig</span>())
     <span style="color:#a6e22e">cores</span> = append(<span style="color:#a6e22e">cores</span>, <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewCore</span>(<span style="color:#a6e22e">je</span>, <span style="color:#a6e22e">fw</span>, <span style="color:#a6e22e">level</span>))

     <span style="color:#75715e">// stdout core 采用 ConsoleEncoder
</span><span style="color:#75715e"></span>     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Stdout</span> {
          <span style="color:#a6e22e">ce</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewConsoleEncoder</span>(<span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">NewDevelopmentEncoderConfig</span>())
          <span style="color:#a6e22e">cores</span> = append(<span style="color:#a6e22e">cores</span>, <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewCore</span>(<span style="color:#a6e22e">ce</span>, <span style="color:#a6e22e">cw</span>, <span style="color:#a6e22e">level</span>))
     }

     <span style="color:#a6e22e">core</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewTee</span>(<span style="color:#a6e22e">cores</span><span style="color:#f92672">...</span>)
     <span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">core</span>)

     <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">ReplaceGlobals</span>(<span style="color:#a6e22e">logger</span>)

     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">err</span>
}</code></pre></div>
<p>logger应该作为私有变量，这样可以统一添加对象的标示。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Object</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>
}

<span style="color:#75715e">// 统一添加标示
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewObject</span>(<span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>){
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Object</span>{
        <span style="color:#a6e22e">logger</span>:  <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;type&#34;</span>,<span style="color:#e6db74">&#34;Object&#34;</span>))
    }

}</code></pre></div>
<h2 id="错误处理">错误处理</h2>

<p>错误处理还是看Dave Cheny的博客《<a href="https://dave.cheney.net/2016/06/12/stack-traces-and-the-errors-package">Stack traces and the errors package</a>》,《<a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">Don’t just check errors, handle them gracefully</a>》。</p>

<ol>
<li>使用类型判断错误。</li>
<li>包装错误，记录错误的上下文。</li>
<li>使用 pakcage <a href="github.com/pkg/errors">errors</a></li>
<li>只处理一次错误，处理错误意味着检查错误值并做出决定。</li>
</ol>

<h3 id="错误日志">错误日志</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;get product by id error&#34;</span>, <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>))</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;level&#34;</span>:<span style="color:#e6db74">&#34;error&#34;</span>,
    <span style="color:#f92672">&#34;ts&#34;</span>:<span style="color:#ae81ff">1564056905.4602501</span>,
    <span style="color:#f92672">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;get product by id error&#34;</span>,
    <span style="color:#f92672">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;product service get product error: get product error[id=2]: record not found&#34;</span>,
    <span style="color:#f92672">&#34;errorVerbose&#34;</span>:<span style="color:#e6db74">&#34;record not found get product error[id=2]
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/pkg/repositorys.(*MysqlProductsRepository).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/pkg/repositorys/products.go:29
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/pkg/services.(*DefaultProductsService).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/pkg/services/products.go:27
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/app/proxy/controllers.(*ProductsController).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/app/proxy/controllers/products.go:30
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Context).Next
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
</span><span style="color:#e6db74">github.com/gin-gonic/gin.RecoveryWithWriter.func1
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/recovery.go:83
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Context).Next
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Engine).handleHTTPRequest
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:389
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Engine).ServeHTTP
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:351
</span><span style="color:#e6db74">net/http.serverHandler.ServeHTTP
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:2774
</span><span style="color:#e6db74">net/http.(*conn).serve
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:1878
</span><span style="color:#e6db74">runtime.goexit
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/runtime/asm_amd64.s:1337
</span><span style="color:#e6db74">product service get product error
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/pkg/services.(*DefaultProductsService).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/pkg/services/products.go:28
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/app/proxy/controllers.(*ProductsController).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/app/proxy/controllers/products.go:30
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Context).Next
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
</span><span style="color:#e6db74">github.com/gin-gonic/gin.RecoveryWithWriter.func1
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/recovery.go:83
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Context).Next
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Engine).handleHTTPRequest
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:389
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Engine).ServeHTTP
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:351
</span><span style="color:#e6db74">net/http.serverHandler.ServeHTTP
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:2774
</span><span style="color:#e6db74">net/http.(*conn).serve
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:1878
</span><span style="color:#e6db74">runtime.goexit
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/runtime/asm_amd64.s:1337&#34;</span>
}</code></pre></div>
<h3 id="接口中返回错误">接口中返回错误</h3>

<p>gin 的使用方式:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#75715e">//
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
}</code></pre></div>
<p>curl <a href="http://localhost:8080/product/5">http://localhost:8080/product/5</a> 输出:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">rpc error: code = Unknown desc = details grpc service get detail error: detail service get detail error: get product error[id=5]: record not found
get rating error
github.com/sdgmf/go-project-sample/internal/app/products/services.(*DefaultProductsService).Get
     /Users/xxx/code/go/go-project-sample/internal/app/products/services/products.go:50
github.com/sdgmf/go-project-sample/internal/app/products/controllers.(*ProductsController).Get
     /Users/xxx/code/go/go-project-sample/internal/app/products/controllers/products.go:30
github.com/gin-gonic/gin.(*Context).Next
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
github.com/opentracing-contrib/go-gin/ginhttp.Middleware.func4
     /Users/xxx/go/pkg/mod/github.com/opentracing-contrib/go-gin@v0.0.0-20190301172248-2e18f8b9c7d4/ginhttp/server.go:99
github.com/gin-gonic/gin.(*Context).Next
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
github.com/sdgmf/go-project-sample/internal/pkg/transports/http/middlewares/ginprom.(*GinPrometheus).Middleware.func1
     /Users/xxx/code/go/go-project-sample/internal/pkg/transports/http/middlewares/ginprom/ginprom.go:105
github.com/gin-gonic/gin.(*Context).Next
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
github.com/gin-contrib/zap.RecoveryWithZap.func1
     /Users/xxx/go/pkg/mod/github.com/gin-contrib/zap@v0.0.0-20190528085758-3cc18cd8fce3/zap.go:109
github.com/gin-gonic/gin.(*Context).Next
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
github.com/gin-contrib/zap.Ginzap.func1
     /Users/xxx/go/pkg/mod/github.com/gin-contrib/zap@v0.0.0-20190528085758-3cc18cd8fce3/zap.go:32
github.com/gin-gonic/gin.(*Context).Next
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
github.com/gin-gonic/gin.RecoveryWithWriter.func1
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/recovery.go:83
github.com/gin-gonic/gin.(*Context).Next
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
github.com/gin-gonic/gin.(*Engine).handleHTTPRequest
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:389
github.com/gin-gonic/gin.(*Engine).ServeHTTP
     /Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:351
net/http.serverHandler.ServeHTTP
     /usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:2774
net/http.(*conn).serve
     /usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:1878
runtime.goexit
     /usr/local/Cellar/go/1.12.6/libexec/src/runtime/asm_amd64.s:1337</code></pre></div>
<h2 id="添加监控">添加监控</h2>

<h3 id="prometheus">Prometheus</h3>

<p>作为新一代的监控框架，Prometheus 具有以下特点：</p>

<ul>
<li>强大的多维度数据模型：</li>
<li>时间序列数据通过 metric 名和键值对来区分。</li>
<li>所有的 metrics 都可以设置任意的多维标签。</li>
<li>数据模型更随意，不需要刻意设置为以点分隔的字符串。</li>
<li>可以对数据模型进行聚合，切割和切片操作。</li>
<li>支持双精度浮点类型，标签可以设为全 unicode。</li>
<li>灵活而强大的查询语句（PromQL）：在同一个查询语句，可以对多个 metrics 进行乘法、加法、连接、取分数位等操作。</li>
<li>易于管理： Prometheus server 是一个单独的二进制文件，可直接在本地工作，不依赖于分布式存储。</li>
<li>高效：平均每个采样点仅占 3.5 bytes，且一个 Prometheus server 可以处理数百万的 metrics。</li>
<li>使用 pull 模式采集时间序列数据，这样不仅有利于本机测试而且可以避免有问题的服务器推送坏的 metrics。</li>
<li>可以采用 push gateway 的方式把时间序列数据推送至 Prometheus server 端。</li>
<li>可以通过服务发现或者静态配置去获取监控的 targets。</li>
<li>有多种可视化图形界面。</li>
<li>易于伸缩</li>
</ul>

<h3 id="go基础监控">Go基础监控</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;github.com/opentracing-contrib/go-gin/ginhttp&#34;</span>
    <span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
)
<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">New</span>()

<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/metrics&#34;</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">WrapH</span>(<span style="color:#a6e22e">promhttp</span>.<span style="color:#a6e22e">Handler</span>()))</code></pre></div>
<h3 id="http监控">http监控</h3>

<p>创建internal/pkg/transports/http/middlewares/ginprom/ginprom.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ginprom</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;strconv&#34;</span>
     <span style="color:#e6db74">&#34;sync&#34;</span>
     <span style="color:#e6db74">&#34;time&#34;</span>

     <span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
     <span style="color:#e6db74">&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
)

<span style="color:#66d9ef">const</span> (
     <span style="color:#a6e22e">metricsPath</span> = <span style="color:#e6db74">&#34;/metrics&#34;</span>
     <span style="color:#a6e22e">faviconPath</span> = <span style="color:#e6db74">&#34;/favicon.ico&#34;</span>
)

<span style="color:#66d9ef">var</span> (
     <span style="color:#a6e22e">httpHistogram</span> = <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">NewHistogramVec</span>(<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">HistogramOpts</span>{
          <span style="color:#a6e22e">Namespace</span>: <span style="color:#e6db74">&#34;http_server&#34;</span>,
          <span style="color:#a6e22e">Name</span>:      <span style="color:#e6db74">&#34;requests_seconds&#34;</span>,
          <span style="color:#a6e22e">Help</span>:      <span style="color:#e6db74">&#34;Histogram of response latency (seconds) of http handlers.&#34;</span>,
     }, []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;code&#34;</span>, <span style="color:#e6db74">&#34;uri&#34;</span>})
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
     <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">httpHistogram</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">handlerPath</span> <span style="color:#66d9ef">struct</span> {
     <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Map</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">hp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">handlerPath</span>) <span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">handler</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
     <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hp</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">handler</span>)
     <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
     }
     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#66d9ef">string</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">hp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">handlerPath</span>) <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">ri</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">RouteInfo</span>) {
     <span style="color:#a6e22e">hp</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">ri</span>.<span style="color:#a6e22e">Handler</span>, <span style="color:#a6e22e">ri</span>.<span style="color:#a6e22e">Path</span>)
}

<span style="color:#75715e">// GinPrometheus  struct
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GinPrometheus</span> <span style="color:#66d9ef">struct</span> {
     <span style="color:#a6e22e">engine</span>   <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Engine</span>
     <span style="color:#a6e22e">ignored</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">bool</span>
     <span style="color:#a6e22e">pathMap</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">handlerPath</span>
     <span style="color:#a6e22e">updated</span> <span style="color:#66d9ef">bool</span>
}

<span style="color:#75715e">// Option 可配置参数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Option</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">GinPrometheus</span>)

<span style="color:#75715e">// Ignore 添加忽略的路径
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Ignore</span>(<span style="color:#a6e22e">path</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">Option</span> {
     <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">gp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GinPrometheus</span>) {
          <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">path</span> {
               <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">ignored</span>[<span style="color:#a6e22e">p</span>] = <span style="color:#66d9ef">true</span>
          }
     }
}

<span style="color:#75715e">// New 构造器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Engine</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Option</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">GinPrometheus</span> {
     <span style="color:#75715e">// 参数验证
</span><span style="color:#75715e"></span>     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
     }
     <span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">GinPrometheus</span>{
          <span style="color:#a6e22e">engine</span>: <span style="color:#a6e22e">e</span>,
          <span style="color:#a6e22e">ignored</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">bool</span>{
               <span style="color:#a6e22e">metricsPath</span>: <span style="color:#66d9ef">true</span>,
               <span style="color:#a6e22e">faviconPath</span>: <span style="color:#66d9ef">true</span>,
          },
          <span style="color:#a6e22e">pathMap</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">handlerPath</span>{},
     }
     <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">o</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">options</span> {
          <span style="color:#a6e22e">o</span>(<span style="color:#a6e22e">gp</span>)
     }
     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gp</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">gp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GinPrometheus</span>) <span style="color:#a6e22e">updatePath</span>() {
     <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">updated</span> = <span style="color:#66d9ef">true</span>
     <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ri</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">engine</span>.<span style="color:#a6e22e">Routes</span>() {
          <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">pathMap</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">ri</span>)
     }
}

<span style="color:#75715e">// Middleware 返回中间件
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">gp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GinPrometheus</span>) <span style="color:#a6e22e">Middleware</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span> {
     <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
          <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">updated</span> {
               <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">updatePath</span>()
          }
          <span style="color:#75715e">// 把不需要的过滤掉
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">ignored</span>[<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">String</span>()] <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span> {
               <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Next</span>()
               <span style="color:#66d9ef">return</span>
          }
          <span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()

          <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Next</span>()

          <span style="color:#a6e22e">httpHistogram</span>.<span style="color:#a6e22e">WithLabelValues</span>(
               <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Method</span>,
               <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Writer</span>.<span style="color:#a6e22e">Status</span>()),
               <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">pathMap</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HandlerName</span>()),
          ).<span style="color:#a6e22e">Observe</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">start</span>).<span style="color:#a6e22e">Seconds</span>())
     }
}</code></pre></div>
<p>在internal/pkg/transports/http/http.go添加:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">ginprom</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">r</span>).<span style="color:#a6e22e">Middleware</span>()) <span style="color:#f92672">//</span> <span style="color:#a6e22e">添加prometheus</span> <span style="color:#a6e22e">监控</span></code></pre></div>
<h3 id="grpc监控">grpc监控</h3>

<p>在server添加：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">          <span style="color:#a6e22e">gs</span> = <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>(
               <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">StreamInterceptor</span>(<span style="color:#a6e22e">grpc_middleware</span>.<span style="color:#a6e22e">ChainStreamServer</span>(
                    <span style="color:#a6e22e">grpc_prometheus</span>.<span style="color:#a6e22e">StreamServerInterceptor</span>,
               )),
               <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryInterceptor</span>(<span style="color:#a6e22e">grpc_middleware</span>.<span style="color:#a6e22e">ChainUnaryServer</span>(
                    <span style="color:#a6e22e">grpc_prometheus</span>.<span style="color:#a6e22e">UnaryServerInterceptor</span>,
               )),
          )</code></pre></div>
<p>在client添加：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">     <span style="color:#a6e22e">grpc_prometheus</span>.<span style="color:#a6e22e">EnableClientHandlingTimeHistogram</span>()
     <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">GrpcDialOptions</span> = append(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">GrpcDialOptions</span>,
          <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithInsecure</span>(),
          <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithUnaryInterceptor</span>(<span style="color:#a6e22e">grpc_middleware</span>.<span style="color:#a6e22e">ChainUnaryClient</span>(
               <span style="color:#a6e22e">grpc_prometheus</span>.<span style="color:#a6e22e">UnaryClientInterceptor</span>,
          ),
          <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithStreamInterceptor</span>(<span style="color:#a6e22e">grpc_middleware</span>.<span style="color:#a6e22e">ChainStreamClient</span>(
               <span style="color:#a6e22e">grpc_prometheus</span>.<span style="color:#a6e22e">StreamClientInterceptor</span>,
          ),
     )</code></pre></div>
<h3 id="添加dashbord">添加dashbord</h3>

<p>可以通过自动生成dashboard，可以集成到自己公司的CICD系统中，上线后dashboard就有了,下面介绍如何通过jsonnet生成dashboard</p>

<ul>
<li>安装<a href="https://jsonnet.org/">jsonnet</a></li>
<li>下载<a href="https://github.com/grafana/grafonnet-lib.git">graonnet-lib</a></li>
</ul>

<p>创建 grafana/dashboard.jsonnet</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsonnet" data-lang="jsonnet">local grafana = import &#39;grafonnet/grafana.libsonnet&#39;;
local dashboard = grafana.dashboard;
local row = grafana.row;
local singlestat = grafana.singlestat;
local prometheus = grafana.prometheus;
local graphPanel = grafana.graphPanel;
local template = grafana.template;
local row = grafana.row;

local app = std.extVar(&#39;app&#39;);

local baseUp() = singlestat.new(
  &#39;Number of instances&#39;,
  datasource=&#39;Prometheus&#39;,
  span=2,
  valueName=&#39;current&#39;,
  transparent=true,
).addTarget(
  prometheus.target(
    &#39;sum(up{app=&#34;&#39; + app + &#39;&#34;})&#39;, instant=true
  )
);

local baseGrpcQPS() = singlestat.new(
  &#39;Number of grpc request  per seconds&#39;,
  datasource=&#39;Prometheus&#39;,
  span=2,
  valueName=&#39;current&#39;,
  transparent=true,
).addTarget(
  prometheus.target(
    &#39;sum(rate(grpc_server_handled_total{app=&#34;&#39; + app + &#39;&#34;,grpc_type=&#34;unary&#34;}[1m]))&#39;,
     instant=true
  )
);

local baseGrpcError() = singlestat.new(
  &#39;Percentage of grpc error request&#39;,
  format=&#39;percent&#39;,
  datasource=&#39;Prometheus&#39;,
  span=2,
  valueName=&#39;current&#39;,
  transparent=true,
).addTarget(
  prometheus.target(
    &#39;sum(rate(grpc_server_handled_total{app=&#34;&#39; + app + &#39;&#34;,grpc_type=&#34;unary&#34;,grpc_code!=&#34;OK&#34;}[1m])) /sum(rate(grpc_server_started_total{app=&#34;&#39; + app + &#39;&#34;,grpc_type=&#34;unary&#34;}[1m])) * 100.0&#39;,
    instant=true
  )
);

local baseHttpQPS() = singlestat.new(
  &#39;Number of http request  per seconds&#39;,
  datasource=&#39;Prometheus&#39;,
  span=2,
  valueName=&#39;current&#39;,
  transparent=true,
).addTarget(
  prometheus.target(
    &#39;sum(rate(http_server_requests_seconds_count{app=&#34;&#39; + app + &#39;&#34;}[1m]))&#39;,
     instant=true
  )
);

local baseHttpError() = singlestat.new(
  &#39;Percentage of http error request&#39;,
  datasource=&#39;Prometheus&#39;,
  format=&#39;percent&#39;,
  span=2,
  valueName=&#39;current&#39;,
  transparent=true,
).addTarget(
  prometheus.target(
    &#39;sum(rate(http_server_requests_seconds_count{app=&#34;&#39; + app + &#39;&#34;,code!=&#34;200&#34;}[1m])) /sum(rate(http_server_requests_seconds_count{app=&#34;&#39; + app + &#39;&#34;}[1m])) * 100.0&#39;,
    instant=true
  )
);

local goState(metric, description=null, format=&#39;none&#39;) = graphPanel.new(
  metric,
  span=6,
  fill=0,
  min=0,
  legend_values=true,
  legend_min=false,
  legend_max=true,
  legend_current=true,
  legend_total=false,
  legend_avg=false,
  legend_alignAsTable=true,
  legend_rightSide=true,
  transparent=true,
  description=description,
).addTarget(
  prometheus.target(
    metric + &#39;{app=&#34;&#39; + app + &#39;&#34;}&#39;,
    datasource=&#39;Prometheus&#39;,
    legendFormat=&#39;{{instance}}&#39;
  )
);




local grpcQPS(kind=&#39;server&#39;, groups=[&#39;grpc_code&#39;]) = graphPanel.new(
  //title=&#39;grpc_&#39; + kind + &#39;_qps_&#39; + std.join(&#39;,&#39;, groups),
  title=&#39;Number of grpc &#39; + kind + &#39; request  per seconds group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  description=&#39;Number of grpc &#39; + kind + &#39; request per seconds  group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  legend_values=true,
  legend_max=true,
  legend_current=true,
  legend_alignAsTable=true,
  legend_rightSide=true,
  transparent=true,
  span=6,
  fill=0,
  min=0,
).addTarget(
  prometheus.target(
    &#39;sum(rate(grpc_&#39; + kind + &#39;_handled_total{app=&#34;&#39; + app + &#39;&#34;,grpc_type=&#34;unary&#34;}[1m])) by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
    datasource=&#39;Prometheus&#39;,
    legendFormat=&#39;{{&#39; + std.join(&#39;}}.{{&#39;, groups) + &#39;}}&#39;
  )
);


local grpcErrorPercentage(kind=&#39;server&#39;, groups=[&#39;instance&#39;]) = graphPanel.new(
  //title=&#39;grpc_&#39; + kind + &#39;_error_percentage_&#39; + std.join(&#39;,&#39;, groups),
  title=&#39;Percentage of grpc &#39; + kind + &#39; error request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  description=&#39;Percentage of grpc &#39; + kind + &#39; error request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  format=&#39;percent&#39;,
  legend_values=true,
  legend_max=true,
  legend_current=true,
  legend_alignAsTable=true,
  legend_rightSide=true,
  transparent=true,
  span=6,
  fill=0,
  min=0,
).addTarget(
  prometheus.target(
    &#39;sum(rate(grpc_&#39;+kind+&#39;_handled_total{app=&#34;&#39; + app + &#39;&#34;,grpc_type=&#34;unary&#34;,grpc_code!=&#34;OK&#34;}[1m])) by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)/sum(rate(grpc_&#39;+kind+&#39;_started_total{app=&#34;&#39; + app + &#39;&#34;,grpc_type=&#34;unary&#34;}[1m])) by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)* 100.0&#39;,
    datasource=&#39;Prometheus&#39;,
    legendFormat=&#39;{{&#39; + std.join(&#39;}}.{{&#39;, groups) + &#39;}}&#39;
  )
);


local grpcLatency(kind=&#39;server&#39;, groups=[&#39;instance&#39;], quantile=&#39;0.99&#39;) = graphPanel.new(
  title=&#39;Latency of grpc &#39; + kind + &#39; request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  description=&#39;Latency of grpc &#39; + kind + &#39; request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  format=&#39;ms&#39;,
  legend_values=true,
  legend_max=true,
  legend_current=true,
  legend_alignAsTable=true,
  legend_rightSide=true,
  transparent=true,
  span=6,
  fill=0,
  min=0,
).addTarget(
  prometheus.target(
    &#39;1000 * histogram_quantile(&#39; + quantile + &#39;,sum(rate(grpc_&#39; + kind + &#39;_handling_seconds_bucket{app=&#34;&#39; + app + &#39;&#34;,grpc_type=&#34;unary&#34;}[1m])) by (&#39; + std.join(&#39;,&#39;, groups) + &#39;,le))&#39;,
    datasource=&#39;Prometheus&#39;,
    legendFormat=&#39;{{&#39; + std.join(&#39;}}.{{&#39;, groups) + &#39;}}&#39;
  )
);




local httpQPS(kind=&#39;server&#39;, groups=[&#39;grpc_code&#39;]) = graphPanel.new(
  title=&#39;Number of http&#39; + kind + &#39; request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;) per seconds&#39;,
  description=&#39;Number of http&#39; + kind + &#39; request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;) per seconds&#39;,
  legend_values=true,
  legend_max=true,
  legend_current=true,
  legend_alignAsTable=true,
  legend_rightSide=true,
  transparent=true,
  span=6,
  fill=0,
  min=0,
).addTarget(
  prometheus.target(
    &#39;sum(rate(http_server_requests_seconds_count{app=&#34;&#39; + app + &#39;&#34;}[1m])) by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
    datasource=&#39;Prometheus&#39;,
    legendFormat=&#39;{{&#39; + std.join(&#39;}}.{{&#39;, groups) + &#39;}}&#39;
  )
);


local httpErrorPercentage(groups=[&#39;instance&#39;]) = graphPanel.new(
  //title=&#39;grpc_&#39; + kind + &#39;_error_percentage_&#39; + std.join(&#39;,&#39;, groups),
  title=&#39;Percentage of http error request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;) &#39;,
  description=&#39;Percentage of http error request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  format=&#39;percent&#39;,
  legend_values=true,
  legend_max=true,
  legend_current=true,
  legend_alignAsTable=true,
  legend_rightSide=true,
  transparent=true,
  span=6,
  fill=0,
  min=0,
).addTarget(
  prometheus.target(
    &#39;sum(rate(http_server_requests_seconds_count{app=&#34;&#39; + app + &#39;&#34;,status!=&#34;200&#34;}[1m])) by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)/sum(rate(http_server_requests_seconds_count{app=&#34;&#39; + app + &#39;&#34;}[1m])) by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)* 100.0&#39;,
    datasource=&#39;Prometheus&#39;,
    legendFormat=&#39;{{&#39; + std.join(&#39;}}.{{&#39;, groups) + &#39;}}&#39;
  )
);

local httpLatency(groups=[&#39;instance&#39;], quantile=&#39;0.99&#39;) = graphPanel.new(
  title=&#39;Latency of http request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  description=&#39;Latency of http request group by (&#39; + std.join(&#39;,&#39;, groups) + &#39;)&#39;,
  format=&#39;ms&#39;,
  legend_values=true,
  legend_max=true,
  legend_current=true,
  legend_alignAsTable=true,
  legend_rightSide=true,
  transparent=true,
  span=6,
  fill=0,
  min=0,
).addTarget(
  prometheus.target(
    &#39;1000 * histogram_quantile(&#39; + quantile + &#39;,sum(rate(http_server_requests_seconds_bucket{app=&#34;&#39; + app + &#39;&#34;}[1m])) by (&#39; + std.join(&#39;,&#39;, groups) + &#39;,le))&#39;,
    datasource=&#39;Prometheus&#39;,
    legendFormat=&#39;{{&#39; + std.join(&#39;}}.{{&#39;, groups) + &#39;}}&#39;
  )
);


dashboard.new(app, schemaVersion=16, tags=[&#39;go&#39;], editable=true, uid=app)
.addPanel(row.new(title=&#39;Base&#39;, collapse=true)
          .addPanel(baseUp(), gridPos={ x: 0, y: 0, w: 4, h: 10 })
          .addPanel(baseGrpcQPS(), gridPos={x: 4, y: 0, w: 4, h: 10 })
          .addPanel(baseGrpcError(), gridPos={x: 8, y: 0, w: 4, h: 10 })
          .addPanel(baseHttpQPS(), gridPos={x: 12, y: 0, w: 4, h: 10 })
          .addPanel(baseHttpError(), gridPos={x: 16, y: 0, w: 4, h: 10 })
          ,{  })
.addPanel(row.new(title=&#39;Go&#39;, collapse=true)
          .addPanel(goState(&#39;go_goroutines&#39;, &#39;Number of goroutines that currently exist&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_alloc_bytes&#39;, &#39;Number of bytes allocated and still in use&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_alloc_bytes_total&#39;, &#39;Total number of bytes allocated, even if freed&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_buck_hash_sys_bytes&#39;, &#39;Number of bytes used by the profiling bucket hash table&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_frees_total&#39;, &#39;Total number of frees&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_gc_cpu_fraction&#39;, &#34;The fraction of this program&#39;s available CPU time used by the GC since the program started.&#34;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_gc_sys_bytes&#39;, &#39;Number of bytes used for garbage collection system metadata&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_heap_alloc_bytes&#39;, &#39;Number of heap bytes allocated and still in use&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_heap_idle_bytes&#39;, &#39;Number of heap bytes waiting to be used&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_heap_inuse_bytes&#39;, &#39;Number of heap bytes that are in use&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_heap_objects&#39;, &#39;Number of allocated objects&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_heap_released_bytes&#39;, &#39;Number of heap bytes released to OS&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_heap_sys_bytes&#39;, &#39;Number of heap bytes obtained from system&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_last_gc_time_seconds&#39;, &#39;Number of seconds since 1970 of last garbage collection&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_lookups_total&#39;, &#39;Total number of pointer lookups&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_mallocs_total&#39;, &#39;Total number of mallocs&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_mcache_inuse_bytes&#39;, &#39;Number of bytes in use by mcache structures&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_mcache_sys_bytes&#39;, &#39;Number of bytes used for mcache structures obtained from system&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_mspan_inuse_bytes&#39;, &#39;Number of bytes in use by mspan structures&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_mspan_sys_bytes&#39;, &#39;Number of bytes used for mspan structures obtained from system&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_next_gc_bytes&#39;, &#39;Number of heap bytes when next garbage collection will take place&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_other_sys_bytes&#39;, &#39;Number of bytes used for other system allocations&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_stack_inuse_bytes&#39;, &#39;Number of bytes in use by the stack allocator&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_stack_sys_bytes&#39;, &#39;Number of bytes obtained from system for stack allocator&#39;), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(goState(&#39;go_memstats_sys_bytes&#39;, &#39;Number of bytes obtained from system&#39;), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})

.addPanel(row.new(title=&#39;Grpc Server request rate&#39;, collapse=true)
          .addPanel(grpcQPS(&#39;server&#39;, [&#39;grpc_code&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcQPS(&#39;server&#39;, [&#39;instance&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(grpcQPS(&#39;server&#39;, [&#39;grpc_service&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcQPS(&#39;server&#39;, [&#39;grpc_service&#39;, &#39;grpc_method&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Grpc Server request error percentage&#39;, collapse=true)
          .addPanel(grpcErrorPercentage(&#39;server&#39;, [&#39;grpc_service&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcErrorPercentage(&#39;server&#39;, [&#39;grpc_service&#39;, &#39;grpc_method&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(grpcErrorPercentage(&#39;server&#39;, [&#39;instance&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Grpc server 99%-tile Latency of requests&#39;, collapse=true)
          .addPanel(grpcLatency(&#39;server&#39;, [&#39;grpc_code&#39;], 0.99), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;server&#39;, [&#39;instance&#39;], 0.99), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;server&#39;, [&#39;grpc_service&#39;], 0.99), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;server&#39;, [&#39;grpc_service&#39;, &#39;grpc_method&#39;], 0.99), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Grpc server 90%-tile Latency of requests&#39;, collapse=true)
        .addPanel(grpcLatency(&#39;server&#39;, [&#39;grpc_code&#39;], 0.90), gridPos={ x: 0, y: 0, w: 12, h: 10 })
        .addPanel(grpcLatency(&#39;server&#39;, [&#39;instance&#39;], 0.90), gridPos={ x: 12, y: 0, w: 12, h: 10 })
        .addPanel(grpcLatency(&#39;server&#39;, [&#39;grpc_service&#39;], 0.90), gridPos={ x: 0, y: 0, w: 12, h: 10 })
        .addPanel(grpcLatency(&#39;server&#39;, [&#39;grpc_service&#39;, &#39;grpc_method&#39;], 0.99), gridPos={ x: 12, y: 0, w: 12, h: 10 })
        , {})
.addPanel(row.new(title=&#39;Grpc client request rate&#39;, collapse=true)
          .addPanel(grpcQPS(&#39;client&#39;, [&#39;grpc_code&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcQPS(&#39;client&#39;, [&#39;instance&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(grpcQPS(&#39;client&#39;, [&#39;grpc_service&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcQPS(&#39;client&#39;, [&#39;grpc_service&#39;, &#39;grpc_method&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Grpc client request error percentage&#39;, collapse=true)
          .addPanel(grpcErrorPercentage(&#39;client&#39;, [&#39;grpc_service&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcErrorPercentage(&#39;client&#39;, [&#39;grpc_service&#39;, &#39;grpc_method&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(grpcErrorPercentage(&#39;client&#39;, [&#39;instance&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Grpc client 99%-tile Latency of requests&#39;, collapse=true)
          .addPanel(grpcLatency(&#39;client&#39;, [&#39;grpc_code&#39;], 0.99), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;client&#39;, [&#39;instance&#39;], 0.99), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;client&#39;, [&#39;grpc_service&#39;], 0.99), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;client&#39;, [&#39;grpc_service&#39;, &#39;grpc_method&#39;], 0.99), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Grpc client 90%-tile Latency of requests&#39;, collapse=true)
          .addPanel(grpcLatency(&#39;client&#39;, [&#39;grpc_code&#39;], 0.90), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;client&#39;, [&#39;instance&#39;], 0.90), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;client&#39;, [&#39;grpc_service&#39;], 0.90), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(grpcLatency(&#39;client&#39;, [&#39;grpc_service&#39;, &#39;grpc_method&#39;], 0.99), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Http server request rate&#39;, collapse=true)
          .addPanel(httpQPS( [&#39;grpc_code&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(httpQPS( [&#39;instance&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(httpQPS( [&#39;grpc_service&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(httpQPS( [&#39;grpc_service&#39;, &#39;grpc_method&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Http server request error percentage&#39;, collapse=true)
          .addPanel(httpErrorPercentage( [&#39;instance&#39;]), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(httpErrorPercentage( [&#39;method&#39;,&#39;uri&#39;]), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Http server 99%-tile Latency of requests&#39;, collapse=true)
          .addPanel(httpLatency( [&#39;grpc_code&#39;], 0.99), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(httpLatency( [&#39;instance&#39;], 0.99), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(httpLatency( [&#39;grpc_service&#39;], 0.99), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(httpLatency( [&#39;grpc_service&#39;, &#39;grpc_method&#39;], 0.99), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})
.addPanel(row.new(title=&#39;Http server 90%-tile Latency of requests&#39;, collapse=true)
          .addPanel(httpLatency( [&#39;grpc_code&#39;], 0.90), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(httpLatency( [&#39;instance&#39;], 0.90), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          .addPanel(httpLatency( [&#39;grpc_service&#39;], 0.90), gridPos={ x: 0, y: 0, w: 12, h: 10 })
          .addPanel(httpLatency( [&#39;grpc_service&#39;, &#39;grpc_method&#39;], 0.90), gridPos={ x: 12, y: 0, w: 12, h: 10 })
          , {})</code></pre></div>
<p>创建grafana/dashboard-api.jsonnet</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsonnet" data-lang="jsonnet">local dash = import &#39;./dashboard.jsonnet&#39;;

{
  dashboard: dash,
  folderId: 0,
  overwrite: false,
}</code></pre></div>
<p>生成jsonnet配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jsonnet -J ./grafana/grafonnet-lib  -o ./grafana/dashboards-api/$$app-api.json  --ext-str app<span style="color:#f92672">=</span>$$app  ./grafana/dashboard-api.jsonnet ;</code></pre></div>
<p>调研grafana api</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -X DELETE --user admin:admin  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#e6db74">&#39;http://localhost:3000/api/dashboards/db/$$app&#39;</span>
curl -x POST --user admin:admin  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> --data-binary <span style="color:#e6db74">&#34;@./grafana/dashboards-api/</span>$$<span style="color:#e6db74">app-api.json&#34;</span> http://localhost:3000/api/dashboards/db </code></pre></div>
<h3 id="生成alermanager-告警">生成alermanager 告警</h3>

<p>TODO</p>

<h2 id="调用链跟踪">调用链跟踪</h2>

<h3 id="jaeger">Jaeger</h3>

<p><a href="https://github.com/jaegertracing/jaeger">Jaeger</a> 是Uber开源的基于<a href="https://opentracing.io/">Opentracing</a> 的一个实现，类似于zipkin。</p>

<p>创建internal/pkg/jaeger/jaeger.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">jaeger</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
     <span style="color:#e6db74">&#34;github.com/opentracing/opentracing-go&#34;</span>
     <span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
     <span style="color:#e6db74">&#34;github.com/spf13/viper&#34;</span>
     <span style="color:#e6db74">&#34;github.com/uber/jaeger-client-go/config&#34;</span>
     <span style="color:#e6db74">&#34;github.com/uber/jaeger-lib/metrics/prometheus&#34;</span>
     <span style="color:#e6db74">&#34;go.uber.org/zap&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConfiguration</span>(<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">Viper</span>, <span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Configuration</span>, <span style="color:#66d9ef">error</span>) {
     <span style="color:#66d9ef">var</span> (
          <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
          <span style="color:#a6e22e">c</span>   = new(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Configuration</span>)
     )

     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">UnmarshalKey</span>(<span style="color:#e6db74">&#34;jaeger&#34;</span>, <span style="color:#a6e22e">c</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unmarshal jaeger configuration error&#34;</span>)
     }

     <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;load jaeger configuration success&#34;</span>)

     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Configuration</span>) (<span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span>, <span style="color:#66d9ef">error</span>) {

     <span style="color:#a6e22e">metricsFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">New</span>()
     <span style="color:#a6e22e">tracer</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NewTracer</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Metrics</span>(<span style="color:#a6e22e">metricsFactory</span>))

     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;create jaeger tracer error&#34;</span>)
     }

     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tracer</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ProviderSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(<span style="color:#a6e22e">New</span>, <span style="color:#a6e22e">NewConfiguration</span>)</code></pre></div>
<h3 id="grpc">Grpc</h3>

<p>修改internal/pkg/transports/grpc/server.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">          <span style="color:#a6e22e">gs</span> = <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>(
               <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">StreamInterceptor</span>(<span style="color:#a6e22e">grpc_middleware</span>.<span style="color:#a6e22e">ChainStreamServer</span>(
                    <span style="color:#a6e22e">otgrpc</span>.<span style="color:#a6e22e">OpenTracingStreamServerInterceptor</span>(<span style="color:#a6e22e">tracer</span>),
               )),
               <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryInterceptor</span>(<span style="color:#a6e22e">grpc_middleware</span>.<span style="color:#a6e22e">ChainUnaryServer</span>(
                    <span style="color:#a6e22e">otgrpc</span>.<span style="color:#a6e22e">OpenTracingServerInterceptor</span>(<span style="color:#a6e22e">tracer</span>),
               )),
          )</code></pre></div>
<p>修改internal/pkg/transports/grpc/client.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">     <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">DialContext</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithInsecure</span>(),
          <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithUnaryInterceptor</span>(<span style="color:#a6e22e">grpc_middleware</span>.<span style="color:#a6e22e">ChainUnaryClient</span>(
               <span style="color:#a6e22e">otgrpc</span>.<span style="color:#a6e22e">OpenTracingClientInterceptor</span>(<span style="color:#a6e22e">tracer</span>)),
          ),
          <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithStreamInterceptor</span>(<span style="color:#a6e22e">grpc_middleware</span>.<span style="color:#a6e22e">ChainStreamClient</span>(
               <span style="color:#a6e22e">otgrpc</span>.<span style="color:#a6e22e">OpenTracingStreamClientInterceptor</span>(<span style="color:#a6e22e">tracer</span>)),
          ),)</code></pre></div>
<h3 id="gin">Gin</h3>

<p>修改internal/pkg/transports/http/http.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;github.com/opentracing-contrib/go-gin/ginhttp&#34;</span>

<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">ginhttp</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#a6e22e">tracer</span>))</code></pre></div>
<h2 id="单元测试">单元测试</h2>

<h3 id="存储层测试">存储层测试</h3>

<p>添加repositorys/wire.go 创建要测试的对象，会根据ProviderSet注入合适的依赖。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// +build wireinject
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">repositorys</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/config&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/database&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/log&#34;</span>
)



<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">testProviderSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(
     <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ProviderSet</span>,
     <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ProviderSet</span>,
     <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ProviderSet</span>,
     <span style="color:#a6e22e">ProviderSet</span>,
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateDetailRepository</span>(<span style="color:#a6e22e">f</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">DetailsRepository</span>, <span style="color:#66d9ef">error</span>) {
     panic(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">testProviderSet</span>))
}</code></pre></div>
<p>添加repositorys/products_test.go,这里采用表格驱动的方法进行测试,存储层测试会依赖数据库。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">repositorys</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;flag&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
     <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;details.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestDetailsRepository_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
     <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

     <span style="color:#a6e22e">sto</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateDetailRepository</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>)
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product Repository error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
     }

     <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
          <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
          <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
          <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">bool</span>
     }{
          {<span style="color:#e6db74">&#34;id=1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>},
          {<span style="color:#e6db74">&#34;id=2&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">true</span>},
          {<span style="color:#e6db74">&#34;id=3&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#66d9ef">true</span>},
     }

     <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
               <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sto</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>)

               <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span> {
                    <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">NoError</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> )
               }<span style="color:#66d9ef">else</span> {
                    <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)
               }
          })
     }
}</code></pre></div>
<p>运行测试</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go test -v ./internal/app/details/repositorys -f <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/configs/details.yml

<span style="color:#f92672">===</span> RUN   TestDetailsRepository_Get
use config file -&gt; /Users/xxx/code/go/go-project-sample/configs/details.yml
<span style="color:#f92672">===</span> RUN   TestDetailsRepository_Get/id<span style="color:#f92672">=</span>1
<span style="color:#f92672">===</span> RUN   TestDetailsRepository_Get/id<span style="color:#f92672">=</span>2
<span style="color:#f92672">===</span> RUN   TestDetailsRepository_Get/id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
--- PASS: TestDetailsRepository_Get <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.11s<span style="color:#f92672">)</span>
    --- PASS: TestDetailsRepository_Get/id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.00s<span style="color:#f92672">)</span>
    --- PASS: TestDetailsRepository_Get/id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.00s<span style="color:#f92672">)</span>
    --- PASS: TestDetailsRepository_Get/id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.00s<span style="color:#f92672">)</span>
PASS
ok      github.com/sdgmf/go-project-sample/internal/app/details/repositorys     <span style="color:#ae81ff">0</span>.128s</code></pre></div>
<h3 id="逻辑层测试">逻辑层测试</h3>

<p>通过mockery自动生成mock对象.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">mockery</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">all</span></code></pre></div>
<p>添加internal/app/details/services/wire.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// +build wireinject
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">services</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/config&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/database&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/log&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/app/details/repositorys&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">testProviderSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(
     <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ProviderSet</span>,
     <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ProviderSet</span>,
     <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ProviderSet</span>,
     <span style="color:#a6e22e">ProviderSet</span>,
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateDetailsService</span>(<span style="color:#a6e22e">cf</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">sto</span> <span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">DetailsRepository</span>) (<span style="color:#a6e22e">DetailsService</span>, <span style="color:#66d9ef">error</span>) {
     panic(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">testProviderSet</span>))
}</code></pre></div>
<p>存储层使用生成的MockProductsRepository，可以直接在用例中定义Mock方法的返回值。</p>

<p>创建 services/details_test.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">services</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;flag&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/models&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/mocks&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/mock&#34;</span>
     <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;details.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestDetailsRepository_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
     <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

     <span style="color:#a6e22e">sto</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">mocks</span>.<span style="color:#a6e22e">DetailsRepository</span>)

     <span style="color:#a6e22e">sto</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">AnythingOfType</span>(<span style="color:#e6db74">&#34;uint64&#34;</span>)).<span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Detail</span>) {
          <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Detail</span>{
               <span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">ID</span>,
          }
     }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
     })

     <span style="color:#a6e22e">svc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateDetailsService</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>, <span style="color:#a6e22e">sto</span>)
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product serviceerror,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
     }

     <span style="color:#75715e">// 表格驱动测试
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
          <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
          <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
          <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">uint64</span>
     }{
          {<span style="color:#e6db74">&#34;1+1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>},
          {<span style="color:#e6db74">&#34;2+3&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>},
          {<span style="color:#e6db74">&#34;4+5&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>},
     }

     <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
               <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>)
               <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;product service get proudct error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
               }

               <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ID</span>)
          })
     }
}</code></pre></div>
<h3 id="控制层测试">控制层测试</h3>

<p>添加controllers/details_test.go,利用httptest进行测试</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">controllers</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;encoding/json&#34;</span>
     <span style="color:#e6db74">&#34;flag&#34;</span>
     <span style="color:#e6db74">&#34;fmt&#34;</span>
     <span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/models&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/mocks&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/mock&#34;</span>
     <span style="color:#e6db74">&#34;io/ioutil&#34;</span>
     <span style="color:#e6db74">&#34;net/http/httptest&#34;</span>
     <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Engine</span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;details.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">setup</span>() {
     <span style="color:#a6e22e">r</span> = <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">New</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestDetailsController_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
     <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
     <span style="color:#a6e22e">setup</span>()

     <span style="color:#a6e22e">sto</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">mocks</span>.<span style="color:#a6e22e">DetailsRepository</span>)

     <span style="color:#a6e22e">sto</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">AnythingOfType</span>(<span style="color:#e6db74">&#34;uint64&#34;</span>)).<span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Detail</span>) {
          <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Detail</span>{
               <span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">ID</span>,
          }
     }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
     })

     <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateDetailsController</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>, <span style="color:#a6e22e">sto</span>)
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product serviceerror,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
     }

     <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/proto/:id&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Get</span>)

     <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
          <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
          <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
          <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">uint64</span>
     }{
          {<span style="color:#e6db74">&#34;1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>},
          {<span style="color:#e6db74">&#34;2&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>},
          {<span style="color:#e6db74">&#34;3&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>},
     }

     <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
               <span style="color:#a6e22e">uri</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/proto/%d&#34;</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>)
               <span style="color:#75715e">// 构造get请求
</span><span style="color:#75715e"></span>               <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httptest</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#a6e22e">uri</span>, <span style="color:#66d9ef">nil</span>)
               <span style="color:#75715e">// 初始化响应
</span><span style="color:#75715e"></span>               <span style="color:#a6e22e">w</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httptest</span>.<span style="color:#a6e22e">NewRecorder</span>()

               <span style="color:#75715e">// 调用相应的controller接口
</span><span style="color:#75715e"></span>               <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>)

               <span style="color:#75715e">// 提取响应
</span><span style="color:#75715e"></span>               <span style="color:#a6e22e">rs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Result</span>()
               <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
                    <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
               }()

               <span style="color:#75715e">// 读取响应body
</span><span style="color:#75715e"></span>               <span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Body</span>)
               <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Detail</span>)
               <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">p</span>)
               <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unmarshal response body error:%v&#34;</span>, <span style="color:#a6e22e">err</span>)
               }

               <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ID</span>)
          })
     }

}</code></pre></div>
<h3 id="grpc测试">grpc测试</h3>

<h4 id="测试server">测试Server</h4>

<p>添加grpcservers/details_test.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">grpcservers</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;context&#34;</span>
     <span style="color:#e6db74">&#34;flag&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/api/proto&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/internal/pkg/models&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/mocks&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/mock&#34;</span>
     <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;details.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestDetailsService_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
     <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

     <span style="color:#a6e22e">service</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">mocks</span>.<span style="color:#a6e22e">DetailsService</span>)

     <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">AnythingOfType</span>(<span style="color:#e6db74">&#34;uint64&#34;</span>)).<span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Detail</span>) {
          <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Detail</span>{
               <span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">ID</span>,
          }
     }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
     })

     <span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateDetailsServer</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>, <span style="color:#a6e22e">service</span>)
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product server error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
     }

     <span style="color:#75715e">// 表格驱动测试
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
          <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
          <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
          <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">uint64</span>
     }{
          {<span style="color:#e6db74">&#34;1+1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>},
          {<span style="color:#e6db74">&#34;2+3&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>},
          {<span style="color:#e6db74">&#34;4+5&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>},
     }

     <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
               <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">GetDetailRequest</span>{
                    <span style="color:#a6e22e">Id</span>: <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>,
               }
               <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">req</span>)
               <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;product service get proudct error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
               }

               <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Id</span>)
          })
     }

}</code></pre></div>
<h4 id="mock-grpc-client">mock grpc client</h4>

<p>/internal/app/products/services/products_test.go:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">services</span>

<span style="color:#f92672">import</span> (
     <span style="color:#e6db74">&#34;context&#34;</span>
     <span style="color:#e6db74">&#34;flag&#34;</span>
     <span style="color:#e6db74">&#34;github.com/golang/protobuf/ptypes&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/api/proto&#34;</span>
     <span style="color:#e6db74">&#34;github.com/sdgmf/go-project-sample/mocks&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
     <span style="color:#e6db74">&#34;github.com/stretchr/testify/mock&#34;</span>
     <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
     <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;products.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestDefaultProductsService_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
     <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

     <span style="color:#a6e22e">detailsCli</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">mocks</span>.<span style="color:#a6e22e">DetailsClient</span>)
     <span style="color:#a6e22e">detailsCli</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">Anything</span>, <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">Anything</span>).
          <span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">GetDetailRequest</span>, <span style="color:#a6e22e">cos</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Detail</span> {
               <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Detail</span>{
                    <span style="color:#a6e22e">Id</span>:          <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Id</span>,
                    <span style="color:#a6e22e">CreatedTime</span>: <span style="color:#a6e22e">ptypes</span>.<span style="color:#a6e22e">TimestampNow</span>(),
               }
          }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">GetDetailRequest</span>, <span style="color:#a6e22e">cos</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) <span style="color:#66d9ef">error</span> {
               <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
          })

     <span style="color:#a6e22e">ratingsCli</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">mocks</span>.<span style="color:#a6e22e">RatingsClient</span>)

     <span style="color:#a6e22e">ratingsCli</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">AnythingOfType</span>(<span style="color:#e6db74">&#34;*proto.GetRatingRequest&#34;</span>)).
          <span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">GetRatingRequest</span>, <span style="color:#a6e22e">cos</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Rating</span> {
               <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Rating</span>{
                    <span style="color:#a6e22e">Id</span>:          <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">ProductID</span>,
                    <span style="color:#a6e22e">UpdatedTime</span>: <span style="color:#a6e22e">ptypes</span>.<span style="color:#a6e22e">TimestampNow</span>(),
               }
          }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">GetRatingRequest</span>, <span style="color:#a6e22e">cos</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) <span style="color:#66d9ef">error</span> {
               <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
          })

     <span style="color:#a6e22e">reviewsCli</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">mocks</span>.<span style="color:#a6e22e">ReviewsClient</span>)

     <span style="color:#a6e22e">reviewsCli</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Query&#34;</span>, <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">AnythingOfType</span>(<span style="color:#e6db74">&#34;*proto.QueryReviewsRequest&#34;</span>)).
          <span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">QueryReviewsRequest</span>, <span style="color:#a6e22e">cos</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">QueryReviewsResponse</span> {
               <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">QueryReviewsResponse</span>{
                    <span style="color:#a6e22e">Reviews</span>: []<span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Review</span>{
                         <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Review</span>{
                              <span style="color:#a6e22e">Id</span>:          <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">ProductID</span>,
                              <span style="color:#a6e22e">CreatedTime</span>: <span style="color:#a6e22e">ptypes</span>.<span style="color:#a6e22e">TimestampNow</span>(),
                         },
                    },
               }
          }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">QueryReviewsRequest</span>, <span style="color:#a6e22e">cos</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) <span style="color:#66d9ef">error</span> {
               <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
          })

     <span style="color:#a6e22e">svc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateProductsService</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>, <span style="color:#a6e22e">detailsCli</span>, <span style="color:#a6e22e">ratingsCli</span>, <span style="color:#a6e22e">reviewsCli</span>)
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product service error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
     }

     <span style="color:#75715e">// 表格驱动测试
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
          <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
          <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
          <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">bool</span>
     }{
          {<span style="color:#e6db74">&#34;id=1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>},
     }

     <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
          <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
               <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>)

               <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span> {
                    <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">NoError</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)
               } <span style="color:#66d9ef">else</span> {
                    <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)
               }
          })
     }
}</code></pre></div>
<h2 id="makefile">Makefile</h2>

<p>编写Makefile</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile">apps <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;products&#39;</span> <span style="color:#e6db74">&#39;details&#39;</span> <span style="color:#e6db74">&#39;ratings&#39;</span> <span style="color:#e6db74">&#39;reviews&#39;</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> run
<span style="color:#a6e22e">run</span><span style="color:#f92672">:</span> proto wire
     <span style="color:#66d9ef">for</span> app in <span style="color:#66d9ef">$(</span>apps<span style="color:#66d9ef">)</span> ;<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     <span style="color:#66d9ef">do</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>           go run ./cmd/$$app -f configs/$$app.yml  &amp; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     <span style="color:#66d9ef">done</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> wire
<span style="color:#a6e22e">wire</span><span style="color:#f92672">:</span>
     wire ./...
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> test
<span style="color:#a6e22e">test</span><span style="color:#f92672">:</span> mock
     <span style="color:#66d9ef">for</span> app in <span style="color:#66d9ef">$(</span>apps<span style="color:#66d9ef">)</span> ;<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     <span style="color:#66d9ef">do</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>          go test -v ./internal/app/$$app/... -f <span style="color:#e6db74">`</span>pwd<span style="color:#e6db74">`</span>/configs/$$app.yml -covermode<span style="color:#f92672">=</span>count -coverprofile<span style="color:#f92672">=</span>dist/cover-$$app.out ;<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     <span style="color:#66d9ef">done</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> build
<span style="color:#a6e22e">build</span><span style="color:#f92672">:</span>
     <span style="color:#66d9ef">for</span> app in <span style="color:#66d9ef">$(</span>apps<span style="color:#66d9ef">)</span> ;<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     <span style="color:#66d9ef">do</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>          GOOS<span style="color:#f92672">=</span>linux GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;amd64&#34;</span> go build -o dist/$$app-linux-amd64 ./cmd/$$app/; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>          GOOS<span style="color:#f92672">=</span>darwin GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;amd64&#34;</span> go build -o dist/$$app-darwin-amd64 ./cmd/$$app/; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     <span style="color:#66d9ef">done</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> cover
<span style="color:#a6e22e">cover</span><span style="color:#f92672">:</span> test
     <span style="color:#66d9ef">for</span> app in <span style="color:#66d9ef">$(</span>apps<span style="color:#66d9ef">)</span> ;<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     <span style="color:#66d9ef">do</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>          go tool cover -html<span style="color:#f92672">=</span>dist/cover-$$app.out; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     <span style="color:#66d9ef">done</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> mock
<span style="color:#a6e22e">mock</span><span style="color:#f92672">:</span>
     mockery --all
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> lint
<span style="color:#a6e22e">lint</span><span style="color:#f92672">:</span>
     golint ./...
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> proto
<span style="color:#a6e22e">proto</span><span style="color:#f92672">:</span>
     protoc -I api/proto ./api/proto/* --go_out<span style="color:#f92672">=</span>plugins<span style="color:#f92672">=</span>grpc:api/proto
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> dash
<span style="color:#a6e22e">dash</span><span style="color:#f92672">:</span> <span style="color:#75715e"># create grafana dashboard
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">for</span> app in <span style="color:#66d9ef">$(</span>apps<span style="color:#66d9ef">)</span> ;<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      <span style="color:#66d9ef">do</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>           jsonnet -J ./grafana/grafonnet-lib   -o ./grafana/dashboards/$$app.json  --ext-str app<span style="color:#f92672">=</span>$$app ./grafana/dashboard.jsonnet ;<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      <span style="color:#66d9ef">done</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> pubdash
<span style="color:#a6e22e">pubdash</span><span style="color:#f92672">:</span>
      <span style="color:#66d9ef">for</span> app in <span style="color:#66d9ef">$(</span>apps<span style="color:#66d9ef">)</span> ;<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      <span style="color:#66d9ef">do</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>           jsonnet -J ./grafana/grafonnet-lib  -o ./grafana/dashboards-api/$$app-api.json  --ext-str app<span style="color:#f92672">=</span>$$app  ./grafana/dashboard-api.jsonnet ; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>           curl -X DELETE --user admin:admin  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#e6db74">&#39;http://localhost:3000/api/dashboards/db/$$app&#39;</span>; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>           curl -x POST --user admin:admin  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> --data-binary <span style="color:#e6db74">&#34;@./grafana/dashboards-api/</span>$$<span style="color:#e6db74">app-api.json&#34;</span> http://localhost:3000/api/dashboards/db ; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      <span style="color:#66d9ef">done</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> docker
<span style="color:#a6e22e">docker-compose</span><span style="color:#f92672">:</span> build dash
     docker-compose -f deployments/docker-compose.yml up --build -d
<span style="color:#a6e22e">all</span><span style="color:#f92672">:</span> lint cover docker
</code></pre></div>
<ol>
<li>make run 运行项目</li>
<li>make wire 生成依赖注入的代码</li>
<li>make mock 生成mock对象</li>
<li>make test 运行单元测试</li>
<li>cover 查看测试用例覆盖度</li>
<li>make build 编译代码</li>
<li>make lint 静态代码检查</li>
<li>make proto 生成grpc代码</li>
<li>make docker-compse 启动所有的服务和依赖的中间件，all-in-one</li>
</ol>

<h2 id="框架或库">框架或库</h2>

<ol>
<li><a href="https://github.com/gin-gonic/gin">Gin</a> MVC库</li>
<li><a href="https://github.com/jinzhu/gorm">gorm</a> ORM库</li>
<li><a href="https://github.com/spf13/viper">viper</a> 配置管理库</li>
<li><a href="https://github.com/uber-go/zap">zap</a> 日志库</li>
<li><a href="https://github.com/grpc/grpc">grpc</a> RPC库</li>
<li><a href="https://github.com/spf13/cobra">Cobar</a> Command开发库</li>
<li><a href="https://opentracing.io/">Opentracing</a> 调用链跟踪</li>
<li><a href="https://github.com/prometheus/client_golang">go-prometheus</a> 服务监控</li>
<li><a href="https://github.com/google/wire">wire</a> 依赖注入</li>
</ol>
    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>