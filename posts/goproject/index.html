<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="author" content="Marlon Cabrera Oliveira">
  <meta name="description" content="Hugo theme using tachyons.io & geomicons.com">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
  <link rel="stylesheet"
    href="http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic|PT+Mono&amp;subset=latin,cyrillic">
  <link rel="stylesheet" href="/css/tachyons.css">
  <style>
    .geomicon {
      width: 1.5em;
      height: 1.5em;
      color: #405660;
    }

    body {
      font-family: 'PT Sans', sans-serif;
    }
  </style>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
</head>

<body>
  <header class="tc pal bb b-near-white">
    <h1 class="f6 thin i link-child"><a href="/">Sdgmf 's Blog</a></h1>
    <nav>
      <ul class="list pln">
        <li class="dib prm"><a href="/">Home</a></li>
        <li class="dib prm"><a href="/post">Blog</a></li>
        <li class="dib prm"><a href="/about">About</a></li>
      </ul>
    </nav>
    <span id="busuanzi_container_site_pv" style='display:none'>
      本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
    <span id="busuanzi_container_site_uv" style='display:none'>
      本站访客数<span id="busuanzi_value_site_uv"></span>人次
    </span>
  </header>

  <main class="pal">

    <h1>GO语言项目应该怎么写?</h1>
    <h2>Jul 24, 2019</h2>
    <span id="busuanzi_container_page_pv" style='display:none'>
      本文总阅读量<span id="busuanzi_value_page_pv"></span>次
    </span>
      

<p>Golang容易学上手快这是很多人喜欢Golang的原因，但是用好Golang远没有这么简单。最近面试了很多Golang开发者，其中不乏一些在大厂工作过的同学，但是聊起Go语言如何去开发一个项目，基本都是学习了两周，用了什么mvc框架，就开始开发了。到底如何组织一个Go语言的项目？近几年一直都使用Golang开发项目，借鉴了很多社区的经验后，总结了一套认为还不错的实践经验。</p>

<p>本文通过一个完整的项目的示例，从Golang项目的结构、分层思想、依赖注入、错误处理、单元测试、框架选择等方面介绍Go语言项目的开发经验。</p>

<h2 id="目的">目的</h2>

<ol>
<li>提供一个完整的go语言项目编程示例</li>
<li>通过示例项目介绍go语言中的编程思想</li>
<li>介绍项目实例遵守的规范</li>
</ol>

<h2 id="示例项目">示例项目</h2>

<p>Github源码<a href="http://github.com/sdgmf/go-project-sample">go-project-sample</a></p>

<h2 id="包结构">包结构</h2>

<p>关于golang项目的包结构，Dave Chaney博客《<a href="https://dave.cheney.net/2014/12/01/five-suggestions-for-setting-up-a-go-project">Five suggestions for setting up a Go project</a>》里讨论了package和command的包设计建议，还有一个社区普遍认可的包结构规范<a href="https://github.com/golang-standards/project-layout">project-layout</a>。在这两个两篇文章的知道下，结合常见的互联网微服务项目，我又细化了如下的项目结构。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.
├── api
│   └── proto
├── builds
├── cmd
│   └── app
├── configs
├── deployments
├── dist
│   └── test
├── internal
│   ├── app
│   │   ├── proxy
│   │   │   ├── controllers
│   │   │   └── grpcservers
│   │   └── tool
│   │       └── clients
│   └── pkg
│       ├── config
│       ├── database
│       ├── log
│       ├── models
│       ├── repositorys
│       ├── services
│       └── transport
│           ├── grpc
│           └── http
└── scripts</code></pre></div>
<h3 id="cmd">\cmd</h3>

<p>同<a href="https://github.com/golang-standards/project-layout">project-layout</a></p>

<blockquote>
<p>该项目的main方法。 每个应用程序的目录名称应与您要拥有的可执行文件的名称相匹配（例如，/cmd/myapp）。 不要在应用程序目录中放入大量代码。 如果您认为代码可以导入并在其他项目中使用，那么它应该存在于/ pkg目录中。 如果代码不可重用或者您不希望其他人重用它，请将该代码放在/ internal目录中。 你会惊讶于别人会做什么，所以要明确你的意图！ 通常有一个小的main函数可以从/ internal和/ pkg目录中导入和调用代码，而不是其他任何东西。</p>
</blockquote>

<h3 id="internal-pkg">\internal\pkg</h3>

<p>同<a href="https://github.com/golang-standards/project-layout">project-layout</a></p>

<blockquote>
<p>私有应用程序和库代码。 这是您不希望其他人在其应用程序或库中导入的代码。
将您的实际应用程序代码放在/internal/app目录（例如/internal/app/myapp）和/internal/ pkg目录中这些应用程序共享的代码（例如/internal/pkg/myprivlib）。</p>
</blockquote>

<p>内部的包采用平铺的方式。</p>

<h3 id="internal-pkg-config">\internal\pkg\config</h3>

<p>加载配置文件,或者从配置中心获取配置和监听配置变动。</p>

<h3 id="internal-pkg-database">\internal\pkg\database</h3>

<p>数据库连接初始化和ORM框架初始化配置。</p>

<h3 id="internal-pkg-models">\internal\pkg\models</h3>

<p>结构体定义。</p>

<h4 id="internal-pkg-repositrys">\internal\pkg\repositrys</h4>

<p>存储层逻辑代码。</p>

<h3 id="internal-pkg-services">\internal\pkg\services</h3>

<p>领域逻辑层代码。</p>

<h3 id="internal-pkg-transport">\internal\pkg\transport</h3>

<p>传输层/控制层逻辑代码</p>

<h3 id="internal-app-proxy">\internal\app\proxy</h3>

<p>应用内部代码</p>

<h3 id="internal-app-controllers">\internal\app\controllers</h3>

<p>http handlers</p>

<h3 id="internal-app-grpcserver">\internal\app\grpcserver</h3>

<p>grpc server 实现</p>

<h3 id="api">/api</h3>

<p>同<a href="https://github.com/golang-standards/project-layout">project-layout</a></p>

<blockquote>
<p>OpenAPI/Swagger规范，JSON模式文件，协议定义文件等。</p>
</blockquote>

<h2 id="分层">分层</h2>

<p>MVC、领域模型、ORM 这些都是通过把特定职责的代码拆分到不同的层次对象里，在Java里这些分层概念在各种框架里都有体现(如SSH,SSM等常用框架组合)，并且早已形成了默认的规约，是否还适用go语言吗？答案是肯定的。Martin Fowler在《<a href="https://book.douban.com/subject/1230559/">企业应用架构模式</a>》就阐述过分层带来的各种好处。</p>

<ol>
<li>便代码复用,提高代码可维护性.如service的代码可被http协议和grpc协议复用，如果增加thrift协议的接口也很方便。</li>
<li>层次清晰，代码可读性更高。</li>
<li>方便单元测试,单元测试往往因为依赖持久的存储而无法进行,如果持久化代码抽取到单独的对象里，这就变的很简单了.</li>
</ol>

<h2 id="显式编程">显式编程</h2>

<p>Golang的开发推崇这样一种显式编程的思想，显式的初始化、方法调用和错误处理.</p>

<ol>
<li>尽可能不要使用宝级别的全局变量.</li>
<li>尽量不要使用init函数，初始化操作可以在main函数中调用，这样方便阅读代码和控制初始化顺序。</li>
<li>函数都要返回错误，用if err != nil 显式的处理错误.</li>
<li>依赖的参数让调用者去控制（控制翻转的思想),可以看下节依赖注入。</li>
</ol>

<p>几个大佬都讨论过这个问题，我就不在重复了，博士Peter的《<a href="http://peter.bourgon.org/blog/2017/06/09/theory-of-modern-go.html">A theory of modern Go</a>》认为魔法代码的核心是”no package level vars; no func init“.单这也不是绝对。
Dave Cheny在《<a href="https://dave.cheney.net/2017/06/11/go-without-package-scoped-variables">go-without-package-scoped-variables</a>》做了更详细的说明.</p>

<blockquote>
<p>虽然这篇文章只是一个思想实验，但很明显禁止所有包范围变量太过严苛，无法作为语言规范使用。从性能的角度来看，解决私人变量使用的定制使用  可能是不切实际的。</p>
</blockquote>

<h2 id="依赖注入">依赖注入</h2>

<p>Java 程序员都很熟悉依赖注入和控制翻转这种思想，Spring正式基于依赖注入的思想开发。依赖注入的好处是解耦，对象的组装交给容器来控制(选择需要的实现类、是否单例和初始化).基于依赖注入可以很方便的实现单元测试和提高代码可维护性。</p>

<p>关于Golang依赖注入的讨论《<a href="https://blog.drewolson.org/dependency-injection-in-go">Dependency Injection in Go</a>》,Golang依赖注入的Package有 Uber的<a href="https://github.com/uber-go/dig">dig</a>,<a href="https://github.com/uber-go/fx">fx</a>,facebook 的 <a href="https://github.com/facebookarchive/inject">inject</a>,google的<a href="https://github.com/google/wire">wire</a>。dig、fx和inject都是基于反射实现，wire是通过代码生成实现，wire的方式是显式的。</p>

<p>本示例通过wire来完成依赖注入. 编写wire.go,wire会根据wire.go生成代码。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// +build wireinject
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/cmd/app&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/config&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/database&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/log&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/services&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/repositorys&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/transport/http&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/transport/grpc&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">providerSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">ProviderSet</span>,
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateApp</span>(<span style="color:#a6e22e">cf</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">App</span>, <span style="color:#66d9ef">error</span>) {
    panic(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">providerSet</span>))
}</code></pre></div>
<p>生成代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/google/wire/cmd/wire

wire ./...</code></pre></div>
<p>生成后的代码在wire_gen.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Code generated by Wire. DO NOT EDIT.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//go:generate wire
</span><span style="color:#75715e">//+build !wireinject
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/cmd/app&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/config&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/database&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/log&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/services&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/repositorys&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/transport/grpc&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/app/proxy/grpcservers&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/transport/http&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/app/proxy/controllers&#34;</span>
)

<span style="color:#75715e">// Injectors from wire.go:
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateApp</span>(<span style="color:#a6e22e">cf</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">App</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">viper</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cf</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">options</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">viper</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">options</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">httpOptions</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">viper</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">databaseOptions</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">viper</span>, <span style="color:#a6e22e">logger</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">databaseOptions</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">productsRepository</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">NewMysqlProductsRepository</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">db</span>)
    <span style="color:#a6e22e">productsService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">NewProductService</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">productsRepository</span>)
    <span style="color:#a6e22e">productsController</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">NewProductsController</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">productsService</span>)
    <span style="color:#a6e22e">initControllers</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">CreateInitControllersFn</span>(<span style="color:#a6e22e">productsController</span>)
    <span style="color:#a6e22e">engine</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRouter</span>(<span style="color:#a6e22e">httpOptions</span>, <span style="color:#a6e22e">initControllers</span>)
    <span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">httpOptions</span>, <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">engine</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">grpcOptions</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">viper</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">productsServer</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpcservers</span>.<span style="color:#a6e22e">NewProductsServer</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">productsService</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">initServers</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpcservers</span>.<span style="color:#a6e22e">CreateInitServersFn</span>(<span style="color:#a6e22e">productsServer</span>)
    <span style="color:#a6e22e">grpcServer</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">grpcOptions</span>, <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">initServers</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">appApp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">grpcServer</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">appApp</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// wire.go:
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">providerSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ProviderSet</span>, <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">ProviderSet</span>)</code></pre></div>
<h2 id="面向接口编程">面向接口编程</h2>

<p>多态和单元测试必须,比较好理解不再解释。</p>

<h2 id="打印日志">打印日志</h2>

<p>使用比较多的两个日志库，<a href="https://github.com/sirupsen/logrus">logrush</a>和<a href="https://github.com/uber-go/zap">zap</a>,个人更喜欢zap。</p>

<p>初始化logger,通过viper加载日志相关配置,lumberjack负责日志切割。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Options is log configration struct
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Options</span> <span style="color:#66d9ef">struct</span> {
     <span style="color:#a6e22e">Filename</span>   <span style="color:#66d9ef">string</span>
     <span style="color:#a6e22e">MaxSize</span>    <span style="color:#66d9ef">int</span>
     <span style="color:#a6e22e">MaxBackups</span> <span style="color:#66d9ef">int</span>
     <span style="color:#a6e22e">MaxAge</span>     <span style="color:#66d9ef">int</span>
     <span style="color:#a6e22e">Level</span>      <span style="color:#66d9ef">string</span>
     <span style="color:#a6e22e">Stdout</span>     <span style="color:#66d9ef">bool</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewOptions</span>(<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">Viper</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Options</span>, <span style="color:#66d9ef">error</span>) {
     <span style="color:#66d9ef">var</span> (
          <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
          <span style="color:#a6e22e">o</span>   = new(<span style="color:#a6e22e">Options</span>)
     )
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">UnmarshalKey</span>(<span style="color:#e6db74">&#34;log&#34;</span>, <span style="color:#a6e22e">o</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
     }

     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">o</span>, <span style="color:#a6e22e">err</span>
}

<span style="color:#75715e">// New for init zap log library
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Options</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>, <span style="color:#66d9ef">error</span>) {
     <span style="color:#66d9ef">var</span> (
          <span style="color:#a6e22e">err</span>    <span style="color:#66d9ef">error</span>
          <span style="color:#a6e22e">level</span>  = <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">NewAtomicLevel</span>()
          <span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>
     )

     <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">level</span>.<span style="color:#a6e22e">UnmarshalText</span>([]byte(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Level</span>))
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
     }

     <span style="color:#a6e22e">fw</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">AddSync</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lumberjack</span>.<span style="color:#a6e22e">Logger</span>{
          <span style="color:#a6e22e">Filename</span>:   <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Filename</span>,
          <span style="color:#a6e22e">MaxSize</span>:    <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">MaxSize</span>, <span style="color:#75715e">// megabytes
</span><span style="color:#75715e"></span>          <span style="color:#a6e22e">MaxBackups</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">MaxBackups</span>,
          <span style="color:#a6e22e">MaxAge</span>:     <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">MaxAge</span>, <span style="color:#75715e">// days
</span><span style="color:#75715e"></span>     })

     <span style="color:#a6e22e">cw</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Lock</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>)

     <span style="color:#75715e">// file core 采用jsonEncoder
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">cores</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Core</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>)
     <span style="color:#a6e22e">je</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewJSONEncoder</span>(<span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">NewProductionEncoderConfig</span>())
     <span style="color:#a6e22e">cores</span> = append(<span style="color:#a6e22e">cores</span>, <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewCore</span>(<span style="color:#a6e22e">je</span>, <span style="color:#a6e22e">fw</span>, <span style="color:#a6e22e">level</span>))

     <span style="color:#75715e">// stdout core 采用 ConsoleEncoder
</span><span style="color:#75715e"></span>     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Stdout</span> {
          <span style="color:#a6e22e">ce</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewConsoleEncoder</span>(<span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">NewDevelopmentEncoderConfig</span>())
          <span style="color:#a6e22e">cores</span> = append(<span style="color:#a6e22e">cores</span>, <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewCore</span>(<span style="color:#a6e22e">ce</span>, <span style="color:#a6e22e">cw</span>, <span style="color:#a6e22e">level</span>))
     }

     <span style="color:#a6e22e">core</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">NewTee</span>(<span style="color:#a6e22e">cores</span><span style="color:#f92672">...</span>)
     <span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">core</span>)

     <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">ReplaceGlobals</span>(<span style="color:#a6e22e">logger</span>)

     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">err</span>
}</code></pre></div>
<p>logger应该作为私有变量，这样可以统一添加对象的标示。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Object</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>
}

<span style="color:#75715e">// 统一添加标示
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewObject</span>(<span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>){
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Object</span>{
        <span style="color:#a6e22e">logger</span>:  <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;type&#34;</span>,<span style="color:#e6db74">&#34;Object&#34;</span>))
    }

}</code></pre></div>
<h2 id="错误处理">错误处理</h2>

<p>错误处理还是看Dave Cheny的博客《<a href="https://dave.cheney.net/2016/06/12/stack-traces-and-the-errors-package">Stack traces and the errors package</a>》,《<a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">Don’t just check errors, handle them gracefully</a>》。</p>

<ol>
<li>使用类型判断错误。</li>
<li>包装错误，记录错误的上下文。</li>
<li>使用 pakcage <a href="github.com/pkg/errors">errors</a></li>
<li>只处理一次错误，处理错误意味着检查错误值并做出决定。</li>
</ol>

<p>错误输出示例</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">pc.logger.Error(</span><span style="color:#e6db74">&#34;get product by id error&#34;</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">zap.Error(err))</span>

{
    <span style="color:#f92672">&#34;level&#34;</span>:<span style="color:#e6db74">&#34;error&#34;</span>,
    <span style="color:#f92672">&#34;ts&#34;</span>:<span style="color:#ae81ff">1564056905.4602501</span>,
    <span style="color:#f92672">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;get product by id error&#34;</span>,
    <span style="color:#f92672">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;product service get product error: get product error[id=2]: record not found&#34;</span>,
    <span style="color:#f92672">&#34;errorVerbose&#34;</span>:<span style="color:#e6db74">&#34;record not found get product error[id=2]
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/pkg/repositorys.(*MysqlProductsRepository).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/pkg/repositorys/products.go:29
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/pkg/services.(*DefaultProductsService).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/pkg/services/products.go:27
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/app/proxy/controllers.(*ProductsController).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/app/proxy/controllers/products.go:30
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Context).Next
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
</span><span style="color:#e6db74">github.com/gin-gonic/gin.RecoveryWithWriter.func1
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/recovery.go:83
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Context).Next
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Engine).handleHTTPRequest
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:389
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Engine).ServeHTTP
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:351
</span><span style="color:#e6db74">net/http.serverHandler.ServeHTTP
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:2774
</span><span style="color:#e6db74">net/http.(*conn).serve
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:1878
</span><span style="color:#e6db74">runtime.goexit
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/runtime/asm_amd64.s:1337
</span><span style="color:#e6db74">product service get product error
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/pkg/services.(*DefaultProductsService).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/pkg/services/products.go:28
</span><span style="color:#e6db74">github.com/zlgwzy/go-project-sample/internal/app/proxy/controllers.(*ProductsController).Get
</span><span style="color:#e6db74">/Users/xxx/code/go/go-project-sample/internal/app/proxy/controllers/products.go:30
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Context).Next
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
</span><span style="color:#e6db74">github.com/gin-gonic/gin.RecoveryWithWriter.func1
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/recovery.go:83
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Context).Next
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/context.go:124
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Engine).handleHTTPRequest
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:389
</span><span style="color:#e6db74">github.com/gin-gonic/gin.(*Engine).ServeHTTP
</span><span style="color:#e6db74">/Users/xxx/go/pkg/mod/github.com/gin-gonic/gin@v1.4.0/gin.go:351
</span><span style="color:#e6db74">net/http.serverHandler.ServeHTTP
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:2774
</span><span style="color:#e6db74">net/http.(*conn).serve
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/net/http/server.go:1878
</span><span style="color:#e6db74">runtime.goexit
</span><span style="color:#e6db74">/usr/local/Cellar/go/1.12.6/libexec/src/runtime/asm_amd64.s:1337&#34;</span>
}</code></pre></div>
<h2 id="单元测试">单元测试</h2>

<h3 id="存储层测试">存储层测试</h3>

<p>添加repositorys/wire.go 创建要测试的对象，会根据ProviderSet注入合适的依赖。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// +build wireinject
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">repositorys</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/config&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/database&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/log&#34;</span>
)



<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">testProviderSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">ProviderSet</span>,
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateProductRepository</span>(<span style="color:#a6e22e">f</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">ProductsRepository</span>, <span style="color:#66d9ef">error</span>) {
    panic(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">testProviderSet</span>))
}</code></pre></div>
<p>添加repositorys/products_test.go,这里采用表格驱动的方法进行测试,存储层测试会依赖数据库。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">repositorys</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;flag&#34;</span>
    <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
    <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;app.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestProductsRepository_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
    <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

    <span style="color:#a6e22e">sto</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateProductRepository</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product Repository error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }

    <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
        <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
        <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
        <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">bool</span>
    }{
        {<span style="color:#e6db74">&#34;1+1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>},
        {<span style="color:#e6db74">&#34;2+3&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">false</span>},
        {<span style="color:#e6db74">&#34;4+5&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#66d9ef">false</span>},
    }

    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
            <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sto</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>)

            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span> {
                <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">NoError</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> )
            }<span style="color:#66d9ef">else</span> {
                <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)
            }
        })
    }
}</code></pre></div>
<p>运行测试</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd internal/pkg/repositorys
 go test . -v -f ../../../configs/proxy.yml 

<span style="color:#f92672">===</span> RUN   TestProductsRepository_Get
<span style="color:#ae81ff">2019</span>/07/26 <span style="color:#ae81ff">14</span>:29:28 use config file:../../../configs/proxy.yml
<span style="color:#ae81ff">2019</span>-07-26T14:29:28.301+0800    INFO    load log options success        <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;url&#34;</span>: <span style="color:#e6db74">&#34;root:xxx@tcp(127.0.0.1:3306)/shop?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span><span style="color:#f92672">}</span>
<span style="color:#f92672">===</span> RUN   TestProductsRepository_Get/1+1
<span style="color:#f92672">===</span> RUN   TestProductsRepository_Get/2+3
<span style="color:#f92672">===</span> RUN   TestProductsRepository_Get/4+5
--- PASS: TestProductsRepository_Get <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.04s<span style="color:#f92672">)</span>
    --- PASS: TestProductsRepository_Get/1+1 <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.00s<span style="color:#f92672">)</span>
    --- PASS: TestProductsRepository_Get/2+3 <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.00s<span style="color:#f92672">)</span>
    --- PASS: TestProductsRepository_Get/4+5 <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.00s<span style="color:#f92672">)</span>
PASS
ok      github.com/zlgwzy/go-project-sample/internal/pkg/repositorys    <span style="color:#ae81ff">0</span>.049s</code></pre></div>
<h3 id="逻辑层测试">逻辑层测试</h3>

<p>通过mockery自动生成mock对象.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">mockery</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">all</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">inpkg</span></code></pre></div>
<p>添加services/wire.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// +build wireinject
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">services</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;github.com/google/wire&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/config&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/database&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/log&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/repositorys&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">testProviderSet</span> = <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewSet</span>(
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ProviderSet</span>,
    <span style="color:#a6e22e">ProviderSet</span>,
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateProductsService</span>(<span style="color:#a6e22e">cf</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">sto</span> <span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">ProductsRepository</span>) (<span style="color:#a6e22e">ProductsService</span>, <span style="color:#66d9ef">error</span>) {
    panic(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">testProviderSet</span>))
}</code></pre></div>
<p>编写单元测试services/products_test.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">services</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;flag&#34;</span>
    <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
    <span style="color:#e6db74">&#34;github.com/stretchr/testify/mock&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/models&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/repositorys&#34;</span>
    <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;proxy.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestProductsRepository_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
    <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

    <span style="color:#a6e22e">sto</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">MockProductsRepository</span>)

    <span style="color:#a6e22e">sto</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">AnythingOfType</span>(<span style="color:#e6db74">&#34;uint64&#34;</span>)).<span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Product</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Product</span>{
            <span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">ID</span>,
        }
    }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    })

    <span style="color:#a6e22e">svc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateProductsService</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>, <span style="color:#a6e22e">sto</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product serviceerror,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }

    <span style="color:#75715e">// 表格驱动测试
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
        <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
        <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
        <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">uint64</span>
    }{
        {<span style="color:#e6db74">&#34;1+1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>},
        {<span style="color:#e6db74">&#34;2+3&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>},
        {<span style="color:#e6db74">&#34;4+5&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>},
    }

    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
            <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;product service get proudct error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
            }

            <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ID</span>)
        })
    }
}</code></pre></div>
<p>存储层使用生成的MockProductsRepository，可以直接在用例中定义Mock方法的返回值。</p>

<h3 id="控制层测试">控制层测试</h3>

<p>添加controllers/products_test.go,利用httptest进行测试</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">controllers</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;encoding/json&#34;</span>
    <span style="color:#e6db74">&#34;flag&#34;</span>
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
    <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
    <span style="color:#e6db74">&#34;github.com/stretchr/testify/mock&#34;</span>
    <span style="color:#e6db74">&#34;io/ioutil&#34;</span>
    <span style="color:#e6db74">&#34;net/http/httptest&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/models&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/repositorys&#34;</span>
    <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Engine</span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;proxy.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">setup</span>() {
    <span style="color:#a6e22e">r</span> = <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">New</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestProductsController_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
    <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
    <span style="color:#a6e22e">setup</span>()

    <span style="color:#a6e22e">sto</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">repositorys</span>.<span style="color:#a6e22e">MockProductsRepository</span>)

    <span style="color:#a6e22e">sto</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">AnythingOfType</span>(<span style="color:#e6db74">&#34;uint64&#34;</span>)).<span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Product</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Product</span>{
            <span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">ID</span>,
        }
    }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    })

    <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateProductsController</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>, <span style="color:#a6e22e">sto</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product serviceerror,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }

    <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/products/:id&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Get</span>)

    <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
        <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
        <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
        <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">uint64</span>
    }{
        {<span style="color:#e6db74">&#34;1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>},
        {<span style="color:#e6db74">&#34;2&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>},
        {<span style="color:#e6db74">&#34;3&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>},
    }

    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
            <span style="color:#a6e22e">uri</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/products/%d&#34;</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>)
            <span style="color:#75715e">// 构造get请求
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httptest</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#a6e22e">uri</span>, <span style="color:#66d9ef">nil</span>)
            <span style="color:#75715e">// 初始化响应
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">w</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httptest</span>.<span style="color:#a6e22e">NewRecorder</span>()

            <span style="color:#75715e">// 调用相应的controller接口
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>)

            <span style="color:#75715e">// 提取响应
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">rs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Result</span>()
            <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
                <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
            }()

            <span style="color:#75715e">// 读取响应body
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Body</span>)
            <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Product</span>)
            <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">p</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unmarshal response body error:%v&#34;</span>, <span style="color:#a6e22e">err</span>)
            }

            <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ID</span>)
        })
    }

}</code></pre></div>
<h3 id="grpc测试">grpc测试</h3>

<p>添加grpcservers/products_test.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">grpcservers</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;context&#34;</span>
    <span style="color:#e6db74">&#34;flag&#34;</span>
    <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
    <span style="color:#e6db74">&#34;github.com/stretchr/testify/mock&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/models&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/internal/pkg/services&#34;</span>
    <span style="color:#e6db74">&#34;github.com/zlgwzy/go-project-sample/api/proto&#34;</span>
    <span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">configFile</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;proxy.yml&#34;</span>, <span style="color:#e6db74">&#34;set config file which viper will loading.&#34;</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestProductsService_Get</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
    <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

    <span style="color:#a6e22e">service</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">MockProductsService</span>)

    <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">AnythingOfType</span>(<span style="color:#e6db74">&#34;uint64&#34;</span>)).<span style="color:#a6e22e">Return</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Product</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Product</span>{
            <span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">ID</span>,
        }
    }, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    })

    <span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateProductsServer</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configFile</span>, <span style="color:#a6e22e">service</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;create product server error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }

    <span style="color:#75715e">// 表格驱动测试
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
        <span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
        <span style="color:#a6e22e">id</span>       <span style="color:#66d9ef">uint64</span>
        <span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">uint64</span>
    }{
        {<span style="color:#e6db74">&#34;1+1&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>},
        {<span style="color:#e6db74">&#34;2+3&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>},
        {<span style="color:#e6db74">&#34;4+5&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>},
    }

    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
            <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">ProductGetRequest</span>{
                <span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">id</span>,
            }
            <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">req</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;product service get proudct error,%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
            }

            <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expected</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ID</span>)
        })
    }

}</code></pre></div>
<h2 id="makefile">Makefile</h2>

<p>编写Makefile</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> run
<span style="color:#a6e22e">run</span><span style="color:#f92672">:</span>
     go run ./cmd -f cmd/app.yml
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> wire
<span style="color:#a6e22e">wire</span><span style="color:#f92672">:</span>
    wire ./...
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> test
<span style="color:#a6e22e">test</span><span style="color:#f92672">:</span>
    go test -v ./... -f <span style="color:#e6db74">`</span>pwd<span style="color:#e6db74">`</span>/cmd/app.yml -covermode<span style="color:#f92672">=</span>count -coverprofile<span style="color:#f92672">=</span>dist/test/cover.out

<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> build
<span style="color:#a6e22e">build</span><span style="color:#f92672">:</span>
    GOOS<span style="color:#f92672">=</span>linux GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;amd64&#34;</span> go build ./cmd -o dist/sample5-linux-amd64
    GOOS<span style="color:#f92672">=</span>darwin GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;amd64&#34;</span> go build ./cmd -o dist/sample5-darwin-amd64
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> cover
<span style="color:#a6e22e">cover</span><span style="color:#f92672">:</span>
    go tool cover -html<span style="color:#f92672">=</span>dist/test/cover.out
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> mock
<span style="color:#a6e22e">mock</span><span style="color:#f92672">:</span>
    mockery --all --inpkg
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> lint
<span style="color:#a6e22e">lint</span><span style="color:#f92672">:</span>
    golint ./...
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> proto
<span style="color:#a6e22e">proto</span><span style="color:#f92672">:</span>
    protoc -I api/proto ./api/proto/products.proto --go_out<span style="color:#f92672">=</span>plugins<span style="color:#f92672">=</span>grpc:api/proto
</code></pre></div>
<ol>
<li>make run 运行项目</li>
<li>make wire 生成依赖注入的代码</li>
<li>make mock 生成mock对象</li>
<li>make test 运行单元测试</li>
<li>cover 查看测试用例覆盖度</li>
<li>make build 编译代码</li>
<li>make lint 静态代码检查</li>
<li>proto 生成grpc代码</li>
</ol>

<h2 id="框架或库">框架或库</h2>

<p>比较喜欢和常用的几个框架或库</p>

<ol>
<li><a href="https://github.com/gin-gonic/gin">Gin</a> MVC库</li>
<li><a href="https://github.com/jinzhu/gorm">gorm</a> ORM库</li>
<li><a href="https://github.com/spf13/viper">viper</a> 配置管理库</li>
<li><a href="https://github.com/uber-go/zap">zap</a> 日志库</li>
<li><a href="https://github.com/grpc/grpc">grpc</a> RPC库</li>
<li><a href="https://github.com/spf13/cobra">Cobar</a> Command开发库</li>
<li><a href="https://opentracing.io/">Opentracing</a> 调用链跟踪</li>
<li><a href="https://github.com/prometheus/client_golang">go-prometheus</a> 服务监控</li>
<li><a href="https://github.com/google/wire">wire</a> 依赖注入</li>
</ol>


  </main>

<div class="post bg-white">
    <script src="https://utteranc.es/client.js"
          repo="sdgmf/sdgmf.github.io"
          issue-term="pathname"
          theme="github-light"
          crossorigin="anonymous"
          async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>
</div>

<footer class="tc center bt b--near-white pvx phm pax-m phxl-l pvx-l">
        <small class="f5 mw7 db center phm lh-copy">
          <nav>
              <ul class="list pln">
                  <li class="dib prm"><a href="https://www.github.com/sdgmf"><span class="js-geomicon geomicon blue" data-icon="github"></span></a></li>
              </ul>
              </nav>
              Copyright-  2015
        </small>
    </footer>
    <script src="http://d2v52k3cl9vedd.cloudfront.net/geomicons/0.2.0/geomicons.min.js.gz"></script>
    <script>
        var icons = document.querySelectorAll('.geomicon');
        Geomicons.inject(icons);
    </script>
  </body>
</html>

